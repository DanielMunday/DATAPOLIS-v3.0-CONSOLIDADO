<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DATAPOLIS AI | MÃ³dulo PlusvalÃ­as Urbanas | IntegraciÃ³n Multi-Agente</title>
    <style>
        :root {
            --primary: #1e40af;
            --secondary: #0891b2;
            --accent: #7c3aed;
            --success: #059669;
            --warning: #d97706;
            --danger: #dc2626;
            --code-bg: #1e293b;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: #f1f5f9; color: #1e293b; line-height: 1.7; }
        .container { max-width: 1500px; margin: 0 auto; padding: 25px; }
        
        .header {
            background: linear-gradient(135deg, #0f172a 0%, #1e3a8a 40%, #7c3aed 80%, #db2777 100%);
            color: white;
            padding: 50px 40px;
            border-radius: 20px;
            margin-bottom: 30px;
            text-align: center;
        }
        .header h1 { font-size: 2.5rem; margin-bottom: 15px; }
        .header .subtitle { font-size: 1.2rem; opacity: 0.95; }
        .header .badges { margin-top: 20px; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        .header .badge { background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; font-size: 0.85rem; }
        
        .section {
            background: white;
            padding: 35px;
            border-radius: 16px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }
        .section h2 {
            color: var(--primary);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--primary);
            font-size: 1.6rem;
        }
        .section h3 { color: var(--secondary); margin: 25px 0 15px; font-size: 1.3rem; }
        .section h4 { color: #475569; margin: 20px 0 12px; font-size: 1.1rem; }
        
        .toc {
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            border: 2px solid #3b82f6;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
        }
        .toc h4 { color: #1e40af; margin-bottom: 15px; }
        .toc ol { margin-left: 25px; }
        .toc li { margin: 8px 0; }
        .toc a { color: #1e40af; text-decoration: none; }
        
        .code-block {
            background: var(--code-bg);
            color: #e2e8f0;
            padding: 20px;
            border-radius: 12px;
            font-family: 'Cascadia Code', 'Fira Code', monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            margin: 15px 0;
            line-height: 1.5;
            white-space: pre;
        }
        
        .file-header {
            background: linear-gradient(135deg, #334155, #475569);
            color: white;
            padding: 10px 20px;
            border-radius: 12px 12px 0 0;
            font-family: monospace;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
        }
        .file-header + .code-block { border-radius: 0 0 12px 12px; margin-top: 0; }
        .file-header .lang { background: rgba(255,255,255,0.2); padding: 3px 10px; border-radius: 10px; font-size: 0.8rem; }
        
        .diagram {
            background: linear-gradient(135deg, #0f172a, #1e293b);
            color: #e2e8f0;
            padding: 25px;
            border-radius: 15px;
            font-family: 'Cascadia Code', monospace;
            font-size: 10px;
            overflow-x: auto;
            white-space: pre;
            line-height: 1.3;
            margin: 25px 0;
        }
        
        table { width: 100%; border-collapse: collapse; margin: 20px 0; font-size: 0.9rem; }
        th { background: linear-gradient(135deg, var(--primary), #1e3a8a); color: white; padding: 14px 18px; text-align: left; }
        td { padding: 14px 18px; border-bottom: 1px solid #e5e7eb; }
        tr:hover { background: #f0f9ff; }
        
        .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-info { background: #e0f2fe; color: #0369a1; }
        .badge-purple { background: #ede9fe; color: #5b21b6; }
        .badge-danger { background: #fee2e2; color: #dc2626; }
        
        .alert { padding: 20px; border-radius: 12px; margin: 20px 0; }
        .alert-info { background: #e0f2fe; border-left: 4px solid #0ea5e9; }
        .alert-warning { background: #fef3c7; border-left: 4px solid #f59e0b; }
        .alert-success { background: #dcfce7; border-left: 4px solid #22c55e; }
        .alert-danger { background: #fee2e2; border-left: 4px solid #ef4444; }
        
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        
        .card { background: linear-gradient(135deg, #f8fafc, #f1f5f9); border: 2px solid #e2e8f0; border-radius: 12px; padding: 20px; }
        .card h4 { color: var(--primary); margin-bottom: 12px; }
        
        .route-card {
            border-radius: 16px;
            padding: 25px;
            color: white;
            margin: 15px 0;
        }
        .route-1 { background: linear-gradient(135deg, #059669, #10b981); }
        .route-2 { background: linear-gradient(135deg, #7c3aed, #8b5cf6); }
        .route-3 { background: linear-gradient(135deg, #0891b2, #06b6d4); }
        
        .agent-card {
            background: linear-gradient(135deg, #f8fafc, #f1f5f9);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
        }
        .agent-card h4 { color: var(--accent); margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .agent-card .icon { font-size: 1.5rem; }
        
        .flow-arrow {
            text-align: center;
            font-size: 2rem;
            color: var(--primary);
            margin: 10px 0;
        }
        
        .entity-box {
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            border: 2px solid #3b82f6;
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
        }
        .entity-box h5 { color: #1e40af; margin-bottom: 10px; }
        
        @media (max-width: 768px) {
            .grid-2, .grid-3 { grid-template-columns: 1fr; }
            .code-block, .diagram { font-size: 0.7rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <header class="header">
            <h1>ğŸ›ï¸ DATAPOLIS AI + MÃ³dulo PlusvalÃ­as Urbanas</h1>
            <p class="subtitle">IntegraciÃ³n del Sistema Multi-Agente con MÃ³dulo de PlusvalÃ­as Urbanas</p>
            <p style="margin-top: 10px; opacity: 0.9;">Caso de Uso: Municipio de Pudahuel (SECPLAC, DOM, AlcaldÃ­a, JurÃ­dica)</p>
            <div class="badges">
                <span class="badge">Python 3.11+ / FastAPI</span>
                <span class="badge">PostgreSQL + PostGIS</span>
                <span class="badge">Ollama (LLM Local)</span>
                <span class="badge">RLM Engine 1M+ tokens</span>
                <span class="badge">ChromaDB RAG</span>
            </div>
        </header>
        
        <!-- TOC -->
        <div class="toc">
            <h4>ğŸ“‘ ÃNDICE DE CONTENIDOS</h4>
            <ol>
                <li><a href="#sintesis">SÃ­ntesis del Estado Actual</a></li>
                <li><a href="#rutas">DefiniciÃ³n de Rutas 1, 2 y 3</a></li>
                <li><a href="#plusvalias">DiseÃ±o del MÃ³dulo de PlusvalÃ­as Urbanas</a></li>
                <li><a href="#agentes">IntegraciÃ³n con Sistema Multi-Agente</a></li>
                <li><a href="#modelo-datos">Modelo de Datos Propuesto</a></li>
                <li><a href="#pudahuel">Caso de Uso: Municipio de Pudahuel</a></li>
                <li><a href="#implementacion">Plan de ImplementaciÃ³n por Etapas</a></li>
                <li><a href="#codigo">CÃ³digo de ImplementaciÃ³n</a></li>
            </ol>
        </div>
        
        <!-- SECCIÃ“N 1: SÃNTESIS DEL ESTADO ACTUAL -->
        <section class="section" id="sintesis">
            <h2>ğŸ“‹ 1. SÃNTESIS DEL ESTADO ACTUAL</h2>
            
            <h3>1.1 Arquitectura del Sistema Multi-Agente DATAPOLIS AI</h3>
            
            <div class="alert alert-info">
                <strong>ğŸ“ Fuente:</strong> Archivo <code>DATAPOLIS_MULTIAGENT_ECOSYSTEM_v2_tar.gz</code> extraÃ­do + Chat "Sistema Multi-Agente"
            </div>
            
            <div class="diagram">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              DATAPOLIS MULTI-AGENT ECOSYSTEM v2.0 - ESTADO ACTUAL                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                     CAPA PRESENTACIÃ“N                                                    â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚   â”‚
â”‚  â”‚   â”‚  Frontend    â”‚  â”‚   Mobile     â”‚  â”‚  Telegram    â”‚  â”‚  WhatsApp    â”‚  â”‚   API        â”‚              â”‚   â”‚
â”‚  â”‚   â”‚  Next.js 14  â”‚  â”‚   React      â”‚  â”‚    Bot       â”‚  â”‚   Business   â”‚  â”‚   Portal     â”‚              â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚   â”‚
â”‚  â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                    â”‚                                                            â”‚
â”‚                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”                                                   â”‚
â”‚                                            â”‚  Nginx/Traefik â”‚                                                   â”‚
â”‚                                            â”‚    Gateway     â”‚                                                   â”‚
â”‚                                            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                                                   â”‚
â”‚                                                    â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                    FASTAPI REST API (main_api.py - 51K)                                   â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚ â”‚
â”‚  â”‚  â”‚ /chatbot   â”‚ â”‚ /validador â”‚ â”‚ /buscador  â”‚ â”‚ /detector  â”‚ â”‚ /actas     â”‚ â”‚ /tributarioâ”‚               â”‚ â”‚
â”‚  â”‚  â”‚   M01      â”‚ â”‚    M02     â”‚ â”‚    M03     â”‚ â”‚    M04     â”‚ â”‚   M05      â”‚ â”‚    M06     â”‚               â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”‚ â”‚
â”‚  â”‚  â”‚ /plusvalia â”‚ â”‚ /reservas  â”‚ â”‚/construc.  â”‚ â”‚/marketplaceâ”‚ â† MÃ“DULOS ACTUALES (10)                     â”‚ â”‚
â”‚  â”‚  â”‚   M07 âš ï¸   â”‚ â”‚    M08     â”‚ â”‚    M09     â”‚ â”‚    M10     â”‚                                              â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                              â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                    â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                        CORE SYSTEMS                                                       â”‚ â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚ â”‚
â”‚  â”‚   â”‚   RLM Engine     â”‚  â”‚    Event Bus     â”‚  â”‚  Memory Manager  â”‚  â”‚   LLM Layer      â”‚                  â”‚ â”‚
â”‚  â”‚   â”‚  1M+ tokens âœ…   â”‚  â”‚   Pub/Sub âœ…     â”‚  â”‚   5 niveles âœ…   â”‚  â”‚  Ollama local âœ… â”‚                  â”‚ â”‚
â”‚  â”‚   â”‚  (37K lÃ­neas)    â”‚  â”‚   (28K lÃ­neas)   â”‚  â”‚  (28K lÃ­neas)    â”‚  â”‚  Llama/Qwen/Mis  â”‚                  â”‚ â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                    â”‚                                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                         DATA LAYER                                                        â”‚ â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                        â”‚ â”‚
â”‚  â”‚   â”‚   PostgreSQL     â”‚  â”‚      Redis       â”‚  â”‚    ChromaDB      â”‚                                        â”‚ â”‚
â”‚  â”‚   â”‚   + PostGIS âœ…   â”‚  â”‚    Cache âœ…      â”‚  â”‚   Vectors âœ…     â”‚                                        â”‚ â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                                                 â”‚
â”‚  âš ï¸ M07 PLUSVALÃA ACTUAL: Solo devuelve datos mock, sin integraciÃ³n real con fuentes de datos municipales     â”‚
â”‚                                                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            </div>
            
            <h3>1.2 Estado del MÃ³dulo M07 PlusvalÃ­a (Actual)</h3>
            
            <div class="alert alert-warning">
                <strong>âš ï¸ Estado Actual:</strong> El M07_PlusvaliaModule existente es una implementaciÃ³n <strong>mÃ­nima</strong> (30 lÃ­neas) que solo retorna datos mock. No tiene:
                <ul style="margin: 10px 0 0 25px;">
                    <li>ConexiÃ³n a fuentes de datos reales (SII, Conservador, DOM)</li>
                    <li>Modelos de predicciÃ³n (Prophet/ARIMA)</li>
                    <li>IntegraciÃ³n con PostGIS para anÃ¡lisis espacial</li>
                    <li>CÃ¡lculos de plusvalÃ­a segÃºn Ley 21.713</li>
                    <li>GeneraciÃ³n de reportes para unidades municipales</li>
                </ul>
            </div>
            
            <h3>1.3 MÃ³dulos del Ecosistema DATAPOLIS AI</h3>
            
            <table>
                <tr>
                    <th>MÃ³dulo</th>
                    <th>Nombre</th>
                    <th>DescripciÃ³n</th>
                    <th>Estado</th>
                    <th>LÃ­neas</th>
                </tr>
                <tr>
                    <td><strong>M01</strong></td>
                    <td>Chatbot Multicanal</td>
                    <td>WhatsApp/Telegram con NLU</td>
                    <td><span class="badge badge-success">Implementado</span></td>
                    <td>~150</td>
                </tr>
                <tr>
                    <td><strong>M02</strong></td>
                    <td>Validador Liquidaciones</td>
                    <td>OCR + ValidaciÃ³n Ley 21.442</td>
                    <td><span class="badge badge-success">Implementado</span></td>
                    <td>~200</td>
                </tr>
                <tr>
                    <td><strong>M03</strong></td>
                    <td>Buscador Arriendos</td>
                    <td>BÃºsqueda semÃ¡ntica + geoloc</td>
                    <td><span class="badge badge-success">Implementado</span></td>
                    <td>~150</td>
                </tr>
                <tr>
                    <td><strong>M04</strong></td>
                    <td>Detector Construcciones</td>
                    <td>Sentinel-2 + cambios</td>
                    <td><span class="badge badge-success">Implementado</span></td>
                    <td>~180</td>
                </tr>
                <tr>
                    <td><strong>M05</strong></td>
                    <td>Generador Actas</td>
                    <td>Whisper + LLM + DOCX</td>
                    <td><span class="badge badge-success">Implementado</span></td>
                    <td>~200</td>
                </tr>
                <tr>
                    <td><strong>M06</strong></td>
                    <td>Consultor Tributario</td>
                    <td>RAG sobre normativa SII</td>
                    <td><span class="badge badge-success">Implementado</span></td>
                    <td>~120</td>
                </tr>
                <tr>
                    <td><strong>M07</strong></td>
                    <td>Mapa PlusvalÃ­a</td>
                    <td>AnÃ¡lisis precios (mock)</td>
                    <td><span class="badge badge-danger">âš ï¸ Mock</span></td>
                    <td>~30</td>
                </tr>
                <tr>
                    <td><strong>M08</strong></td>
                    <td>Reservas Amenidades</td>
                    <td>Booking espacios</td>
                    <td><span class="badge badge-success">Implementado</span></td>
                    <td>~80</td>
                </tr>
                <tr>
                    <td><strong>M09</strong></td>
                    <td>Constructibilidad</td>
                    <td>AnÃ¡lisis PRC</td>
                    <td><span class="badge badge-warning">Parcial</span></td>
                    <td>~60</td>
                </tr>
                <tr>
                    <td><strong>M10</strong></td>
                    <td>Marketplace</td>
                    <td>Proveedores</td>
                    <td><span class="badge badge-success">Implementado</span></td>
                    <td>~100</td>
                </tr>
                <tr style="background: #fef3c7;">
                    <td><strong>M07-PU</strong></td>
                    <td>PlusvalÃ­as Urbanas</td>
                    <td>MÃ³dulo completo municipal</td>
                    <td><span class="badge badge-purple">ğŸ¯ A Desarrollar</span></td>
                    <td>~2,000+</td>
                </tr>
            </table>
            
            <h3>1.4 Componentes Core Implementados</h3>
            
            <div class="grid-3">
                <div class="card">
                    <h4>ğŸ§  RLM Engine</h4>
                    <p><strong>Estado:</strong> âœ… Completo (37K lÃ­neas)</p>
                    <p>Motor de Lenguaje Recursivo para procesar contextos de +1M tokens basado en paper MIT CSAIL.</p>
                    <ul style="margin: 10px 0 0 15px; font-size: 0.9rem;">
                        <li>REPL Environment</li>
                        <li>Chunking adaptativo</li>
                        <li>Sub-llamadas recursivas</li>
                    </ul>
                </div>
                <div class="card">
                    <h4>ğŸ“¡ Event Bus</h4>
                    <p><strong>Estado:</strong> âœ… Completo (28K lÃ­neas)</p>
                    <p>Sistema Pub/Sub para comunicaciÃ³n entre agentes y mÃ³dulos.</p>
                    <ul style="margin: 10px 0 0 15px; font-size: 0.9rem;">
                        <li>Eventos tipados</li>
                        <li>Handlers async</li>
                        <li>Persistencia Redis</li>
                    </ul>
                </div>
                <div class="card">
                    <h4>ğŸ—ƒï¸ Memory Manager</h4>
                    <p><strong>Estado:</strong> âœ… Completo (28K lÃ­neas)</p>
                    <p>Memoria jerÃ¡rquica de 5 niveles para agentes.</p>
                    <ul style="margin: 10px 0 0 15px; font-size: 0.9rem;">
                        <li>EpisÃ³dica</li>
                        <li>Corto/Largo plazo</li>
                        <li>SemÃ¡ntica/Procedimental</li>
                    </ul>
                </div>
            </div>
        </section>
        
        <!-- SECCIÃ“N 2: DEFINICIÃ“N DE RUTAS -->
        <section class="section" id="rutas">
            <h2>ğŸ›¤ï¸ 2. DEFINICIÃ“N DE RUTAS 1, 2 y 3</h2>
            
            <div class="alert alert-info">
                <strong>ğŸ“Œ Contexto:</strong> Las 3 rutas definidas en conversaciones anteriores se integran secuencialmente siguiendo un orden lÃ³gico de desarrollo de software.
            </div>
            
            <div class="route-card route-1">
                <h3>ğŸ›¤ï¸ RUTA 1: ConsolidaciÃ³n Backend + Base de Datos</h3>
                <p style="opacity: 0.95; margin: 15px 0;">Fundamentos tÃ©cnicos y arquitectura de datos para soportar el ecosistema completo.</p>
                
                <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 12px; margin-top: 15px;">
                    <h4 style="color: white; margin-bottom: 15px;">Objetivos EspecÃ­ficos:</h4>
                    <ul style="margin-left: 20px; line-height: 2;">
                        <li>âœ… Migrar a SQLModel + Alembic para migraciones formales</li>
                        <li>âœ… DiseÃ±ar modelo de datos completo para PlusvalÃ­as Urbanas</li>
                        <li>âœ… Configurar PostgreSQL + PostGIS para anÃ¡lisis espacial</li>
                        <li>âœ… Implementar schemas Pydantic V2 estrictos</li>
                        <li>âœ… Testing con pytest (coverage 80%+)</li>
                    </ul>
                    
                    <h4 style="color: white; margin: 20px 0 15px;">Entregables:</h4>
                    <ul style="margin-left: 20px; line-height: 2;">
                        <li>ğŸ“¦ Modelos SQLModel para 15+ entidades</li>
                        <li>ğŸ“¦ Migraciones Alembic versionadas</li>
                        <li>ğŸ“¦ Schemas Pydantic para validaciÃ³n</li>
                        <li>ğŸ“¦ docker-compose.yml production-ready</li>
                        <li>ğŸ“¦ Tests unitarios + integraciÃ³n</li>
                    </ul>
                    
                    <p style="margin-top: 15px;"><strong>Tiempo estimado:</strong> 3-4 semanas</p>
                </div>
            </div>
            
            <div class="route-card route-2">
                <h3>ğŸ›¤ï¸ RUTA 2: MÃ³dulo PlusvalÃ­as Urbanas + Agentes</h3>
                <p style="opacity: 0.95; margin: 15px 0;">Desarrollo completo del mÃ³dulo de anÃ¡lisis de plusvalÃ­as con integraciÃ³n multi-agente.</p>
                
                <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 12px; margin-top: 15px;">
                    <h4 style="color: white; margin-bottom: 15px;">Objetivos EspecÃ­ficos:</h4>
                    <ul style="margin-left: 20px; line-height: 2;">
                        <li>âœ… Implementar M07-PU PlusvalÃ­as Urbanas completo</li>
                        <li>âœ… Crear agentes especializados (Datos, ModelaciÃ³n, Regulatorio, VisualizaciÃ³n)</li>
                        <li>âœ… Integrar con RLM Engine para anÃ¡lisis de documentos largos</li>
                        <li>âœ… Conectar fuentes de datos (SII, Conservador, DOM, IDE Chile)</li>
                        <li>âœ… Implementar modelos predictivos (Prophet, ARIMA, ML)</li>
                    </ul>
                    
                    <h4 style="color: white; margin: 20px 0 15px;">Entregables:</h4>
                    <ul style="margin-left: 20px; line-height: 2;">
                        <li>ğŸ“¦ Servicio M07_PlusvaliaUrbana completo (~2,000 lÃ­neas)</li>
                        <li>ğŸ“¦ Router FastAPI con 20+ endpoints</li>
                        <li>ğŸ“¦ 4 Agentes especializados integrados</li>
                        <li>ğŸ“¦ Conectores a APIs externas</li>
                        <li>ğŸ“¦ Modelos ML entrenados</li>
                    </ul>
                    
                    <p style="margin-top: 15px;"><strong>Tiempo estimado:</strong> 4-6 semanas</p>
                </div>
            </div>
            
            <div class="route-card route-3">
                <h3>ğŸ›¤ï¸ RUTA 3: Frontend + Caso Municipio Pudahuel</h3>
                <p style="opacity: 0.95; margin: 15px 0;">Interfaz de usuario y despliegue para el caso de uso municipal.</p>
                
                <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 12px; margin-top: 15px;">
                    <h4 style="color: white; margin-bottom: 15px;">Objetivos EspecÃ­ficos:</h4>
                    <ul style="margin-left: 20px; line-height: 2;">
                        <li>âœ… Dashboard ejecutivo para AlcaldÃ­a</li>
                        <li>âœ… Panel SECPLAC con mapas temÃ¡ticos</li>
                        <li>âœ… Visor DOM para anÃ¡lisis de permisos</li>
                        <li>âœ… Reportes JurÃ­dica sobre conflictos</li>
                        <li>âœ… API de integraciÃ³n con sistemas municipales</li>
                    </ul>
                    
                    <h4 style="color: white; margin: 20px 0 15px;">Entregables:</h4>
                    <ul style="margin-left: 20px; line-height: 2;">
                        <li>ğŸ“¦ Frontend Next.js + TypeScript</li>
                        <li>ğŸ“¦ Mapas interactivos (Leaflet/MapLibre)</li>
                        <li>ğŸ“¦ Dashboards por unidad municipal</li>
                        <li>ğŸ“¦ DocumentaciÃ³n de uso</li>
                        <li>ğŸ“¦ Deploy en servidor municipal</li>
                    </ul>
                    
                    <p style="margin-top: 15px;"><strong>Tiempo estimado:</strong> 4-5 semanas</p>
                </div>
            </div>
            
            <h3>2.1 ConexiÃ³n entre Rutas y Sistema Multi-Agente</h3>
            
            <div class="diagram">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    INTEGRACIÃ“N RUTAS 1-2-3 + MULTI-AGENTE                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                                                 â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚    â”‚                                         RUTA 1: BACKEND                                             â”‚     â”‚
â”‚    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚     â”‚
â”‚    â”‚    â”‚   SQLModel   â”‚â”€â”€â”€â–ºâ”‚   Alembic    â”‚â”€â”€â”€â–ºâ”‚   PostGIS    â”‚â”€â”€â”€â–ºâ”‚   Testing    â”‚                    â”‚     â”‚
â”‚    â”‚    â”‚   Modelos    â”‚    â”‚  Migraciones â”‚    â”‚   Espacial   â”‚    â”‚   pytest     â”‚                    â”‚     â”‚
â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚     â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                        â”‚                                                        â”‚
â”‚                                                        â–¼                                                        â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚    â”‚                                     RUTA 2: PLUSVALÃAS + AGENTES                                    â”‚     â”‚
â”‚    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚     â”‚
â”‚    â”‚    â”‚  M07-PU      â”‚â”€â”€â”€â–ºâ”‚   AGENTES    â”‚â”€â”€â”€â–ºâ”‚   RLM        â”‚â”€â”€â”€â–ºâ”‚   ML/AI      â”‚                    â”‚     â”‚
â”‚    â”‚    â”‚  Servicio    â”‚    â”‚  4 tipos     â”‚    â”‚   Engine     â”‚    â”‚  PredicciÃ³n  â”‚                    â”‚     â”‚
â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚     â”‚
â”‚    â”‚           â”‚                   â”‚                   â”‚                   â”‚                             â”‚     â”‚
â”‚    â”‚           â–¼                   â–¼                   â–¼                   â–¼                             â”‚     â”‚
â”‚    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚     â”‚
â”‚    â”‚    â”‚                        EVENT BUS (ComunicaciÃ³n Inter-Agente)                            â”‚     â”‚     â”‚
â”‚    â”‚    â”‚   plusvalia.calculada â”‚ datos.actualizados â”‚ prediccion.lista â”‚ reporte.generado       â”‚     â”‚     â”‚
â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚     â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                        â”‚                                                        â”‚
â”‚                                                        â–¼                                                        â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚    â”‚                                   RUTA 3: FRONTEND + PUDAHUEL                                       â”‚     â”‚
â”‚    â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚     â”‚
â”‚    â”‚    â”‚  Dashboard   â”‚â”€â”€â”€â–ºâ”‚   Mapas      â”‚â”€â”€â”€â–ºâ”‚  Reportes    â”‚â”€â”€â”€â–ºâ”‚   Deploy     â”‚                    â”‚     â”‚
â”‚    â”‚    â”‚  AlcaldÃ­a    â”‚    â”‚  SECPLAC     â”‚    â”‚  JurÃ­dica    â”‚    â”‚  Municipal   â”‚                    â”‚     â”‚
â”‚    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚     â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            </div>
        </section>
        
        <!-- SECCIÃ“N 3: DISEÃ‘O DEL MÃ“DULO PLUSVALÃAS URBANAS -->
        <section class="section" id="plusvalias">
            <h2>ğŸ“ˆ 3. DISEÃ‘O DEL MÃ“DULO DE PLUSVALÃAS URBANAS (M07-PU)</h2>
            
            <h3>3.1 PropÃ³sito Detallado</h3>
            
            <div class="alert alert-success">
                <strong>ğŸ¯ Objetivo Principal:</strong> Proporcionar una herramienta integral de monitoreo, anÃ¡lisis y prospectiva territorial para el Municipio de Pudahuel, integrando informaciÃ³n pÃºblica y privada para apoyar la toma de decisiones sobre consolidaciÃ³n urbana, inversiones y normativa.
            </div>
            
            <div class="grid-2">
                <div class="card">
                    <h4>ğŸ“Š Funciones de AnÃ¡lisis</h4>
                    <ul style="margin: 10px 0 0 15px; line-height: 2;">
                        <li><strong>CÃ¡lculo de PlusvalÃ­a:</strong> SegÃºn Ley 21.713</li>
                        <li><strong>ValorizaciÃ³n de Suelo:</strong> UF/mÂ² por zona</li>
                        <li><strong>Tendencias HistÃ³ricas:</strong> Series temporales 10 aÃ±os</li>
                        <li><strong>PredicciÃ³n:</strong> Proyecciones 1-5 aÃ±os (Prophet/ARIMA)</li>
                        <li><strong>AnÃ¡lisis Comparativo:</strong> Benchmarking comunal</li>
                    </ul>
                </div>
                <div class="card">
                    <h4>ğŸ—ºï¸ Funciones Espaciales</h4>
                    <ul style="margin: 10px 0 0 15px; line-height: 2;">
                        <li><strong>Mapas TemÃ¡ticos:</strong> Heatmaps de valor</li>
                        <li><strong>Zonas de Influencia:</strong> Buffer analysis</li>
                        <li><strong>DetecciÃ³n de Cambios:</strong> Sentinel-2</li>
                        <li><strong>AnÃ¡lisis de Proximidad:</strong> Servicios, transporte</li>
                        <li><strong>ZonificaciÃ³n:</strong> PRC y usos de suelo</li>
                    </ul>
                </div>
            </div>
            
            <h3>3.2 Entradas de Datos (Inputs)</h3>
            
            <table>
                <tr>
                    <th>Fuente</th>
                    <th>Tipo de Datos</th>
                    <th>Frecuencia</th>
                    <th>MÃ©todo Acceso</th>
                </tr>
                <tr>
                    <td><strong>SII</strong></td>
                    <td>AvalÃºos fiscales, transacciones, roles</td>
                    <td>Semestral</td>
                    <td>API / Scraping</td>
                </tr>
                <tr>
                    <td><strong>Conservador Bienes RaÃ­ces</strong></td>
                    <td>Inscripciones, hipotecas, prohibiciones</td>
                    <td>Diaria</td>
                    <td>API / Manual</td>
                </tr>
                <tr>
                    <td><strong>DOM Municipal</strong></td>
                    <td>Permisos edificaciÃ³n, recepciones</td>
                    <td>Mensual</td>
                    <td>IntegraciÃ³n directa</td>
                </tr>
                <tr>
                    <td><strong>IDE Chile</strong></td>
                    <td>Catastro, lÃ­mites, equipamiento</td>
                    <td>Anual</td>
                    <td>WFS/WMS</td>
                </tr>
                <tr>
                    <td><strong>Portales Inmobiliarios</strong></td>
                    <td>Precios oferta, arriendos</td>
                    <td>Semanal</td>
                    <td>Scraping</td>
                </tr>
                <tr>
                    <td><strong>Sentinel-2</strong></td>
                    <td>ImÃ¡genes satelitales</td>
                    <td>5 dÃ­as</td>
                    <td>Copernicus API</td>
                </tr>
                <tr>
                    <td><strong>INE/Censo</strong></td>
                    <td>Datos socioeconÃ³micos</td>
                    <td>Decenal</td>
                    <td>CSV/API</td>
                </tr>
                <tr>
                    <td><strong>MINVU</strong></td>
                    <td>Proyectos habitacionales, subsidios</td>
                    <td>Trimestral</td>
                    <td>API / Manual</td>
                </tr>
            </table>
            
            <h3>3.3 Salidas (Outputs)</h3>
            
            <div class="grid-3">
                <div class="entity-box">
                    <h5>ğŸ“Š Indicadores</h5>
                    <ul style="margin: 10px 0 0 15px; font-size: 0.9rem; line-height: 1.8;">
                        <li>PlusvalÃ­a % (anual, acumulada)</li>
                        <li>UF/mÂ² por manzana</li>
                        <li>Ãndice de consolidaciÃ³n</li>
                        <li>Ratio inversiÃ³n/valor</li>
                        <li>Score de riesgo</li>
                    </ul>
                </div>
                <div class="entity-box">
                    <h5>ğŸ—ºï¸ Mapas TemÃ¡ticos</h5>
                    <ul style="margin: 10px 0 0 15px; font-size: 0.9rem; line-height: 1.8;">
                        <li>Heatmap de valores</li>
                        <li>Zonas de crecimiento</li>
                        <li>Ãreas de inversiÃ³n</li>
                        <li>Conflictos normativos</li>
                        <li>Proyecciones espaciales</li>
                    </ul>
                </div>
                <div class="entity-box">
                    <h5>ğŸ“‘ Reportes</h5>
                    <ul style="margin: 10px 0 0 15px; font-size: 0.9rem; line-height: 1.8;">
                        <li>Informe SECPLAC mensual</li>
                        <li>Alertas DOM permisos</li>
                        <li>Dashboard AlcaldÃ­a</li>
                        <li>AnÃ¡lisis JurÃ­dica</li>
                        <li>Exportables PDF/Excel</li>
                    </ul>
                </div>
            </div>
            
            <h3>3.4 InteracciÃ³n con Otros MÃ³dulos</h3>
            
            <div class="diagram">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              INTERACCIONES DEL MÃ“DULO PLUSVALÃAS URBANAS (M07-PU)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                                                 â”‚
â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”‚
â”‚                                    â”‚      M07-PU PLUSVALÃAS      â”‚                                              â”‚
â”‚                                    â”‚         URBANAS             â”‚                                              â”‚
â”‚                                    â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚                                              â”‚
â”‚                                    â”‚   â”‚ â€¢ CÃ¡lculo plusvalÃ­aâ”‚     â”‚                                              â”‚
â”‚                                    â”‚   â”‚ â€¢ PredicciÃ³n ML    â”‚     â”‚                                              â”‚
â”‚                                    â”‚   â”‚ â€¢ AnÃ¡lisis espacialâ”‚     â”‚                                              â”‚
â”‚                                    â”‚   â”‚ â€¢ Reportes         â”‚     â”‚                                              â”‚
â”‚                                    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚                                              â”‚
â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                              â”‚
â”‚                                               â”‚                                                                  â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚         â”‚                 â”‚                  â”‚                  â”‚                 â”‚                            â”‚
â”‚         â–¼                 â–¼                  â–¼                  â–¼                 â–¼                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚     M04      â”‚  â”‚     M06      â”‚  â”‚     M09      â”‚  â”‚  DATAPOLIS   â”‚  â”‚    ÃGORA     â”‚                      â”‚
â”‚  â”‚  Detector    â”‚  â”‚  Tributario  â”‚  â”‚Constructib.  â”‚  â”‚   v3.0       â”‚  â”‚   GeoIA      â”‚                      â”‚
â”‚  â”‚Construccionesâ”‚  â”‚   RAG SII    â”‚  â”‚    PRC       â”‚  â”‚  23 mÃ³dulos  â”‚  â”‚   v4.0       â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚         â”‚                 â”‚                  â”‚                  â”‚                 â”‚                            â”‚
â”‚         â”‚                 â”‚                  â”‚                  â”‚                 â”‚                            â”‚
â”‚         â–¼                 â–¼                  â–¼                  â–¼                 â–¼                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚                                        EVENT BUS                                                    â”‚      â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚      â”‚
â”‚  â”‚  â”‚construccion â”‚ â”‚consulta.    â”‚ â”‚normativa.   â”‚ â”‚valoracion.  â”‚ â”‚prediccion.  â”‚ â”‚reporte.     â”‚   â”‚      â”‚
â”‚  â”‚  â”‚.detectada   â”‚ â”‚tributaria   â”‚ â”‚actualizada  â”‚ â”‚calculada    â”‚ â”‚generada     â”‚ â”‚listo        â”‚   â”‚      â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                                                                 â”‚
â”‚  FLUJOS DE DATOS:                                                                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                                              â”‚
â”‚  M04 â†’ M07-PU: Alertas de nuevas construcciones para recalcular plusvalÃ­a de zona afectada                    â”‚
â”‚  M06 â†’ M07-PU: InformaciÃ³n tributaria para cÃ¡lculos de impuesto plusvalÃ­a (Ley 21.713)                        â”‚
â”‚  M09 â†’ M07-PU: Potencial constructibilidad afecta valorizaciÃ³n futura de predios                              â”‚
â”‚  DATAPOLIS â†’ M07-PU: Credit Score y valorizaciÃ³n IVS 2022 de propiedades                                       â”‚
â”‚  ÃGORA â†’ M07-PU: AnÃ¡lisis de riesgos naturales y scores territoriales                                          â”‚
â”‚                                                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            </div>
        </section>
        
        <!-- SECCIÃ“N 4: INTEGRACIÃ“N CON SISTEMA MULTI-AGENTE -->
        <section class="section" id="agentes">
            <h2>ğŸ¤– 4. INTEGRACIÃ“N CON SISTEMA MULTI-AGENTE (DATAPOLIS AI)</h2>
            
            <h3>4.1 Agentes Especializados para PlusvalÃ­as Urbanas</h3>
            
            <div class="grid-2">
                <div class="agent-card">
                    <h4><span class="icon">ğŸ“Š</span> Agente de Datos (DataAgent)</h4>
                    <p><strong>Rol:</strong> RecolecciÃ³n, validaciÃ³n y normalizaciÃ³n de datos de mÃºltiples fuentes.</p>
                    <p><strong>Responsabilidades:</strong></p>
                    <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                        <li>Conectar con APIs externas (SII, CBR, IDE Chile)</li>
                        <li>Ejecutar scrapers de portales inmobiliarios</li>
                        <li>Validar integridad y consistencia de datos</li>
                        <li>Detectar anomalÃ­as y datos faltantes</li>
                        <li>Emitir eventos <code>datos.actualizados</code></li>
                    </ul>
                    <p style="margin-top: 15px;"><strong>Herramientas:</strong> Scrapy, Pandas, Great Expectations</p>
                </div>
                
                <div class="agent-card">
                    <h4><span class="icon">ğŸ§®</span> Agente de ModelaciÃ³n (ModelAgent)</h4>
                    <p><strong>Rol:</strong> EjecuciÃ³n de modelos matemÃ¡ticos y predictivos.</p>
                    <p><strong>Responsabilidades:</strong></p>
                    <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                        <li>Calcular plusvalÃ­a segÃºn fÃ³rmulas Ley 21.713</li>
                        <li>Ejecutar modelos Prophet/ARIMA para proyecciones</li>
                        <li>Entrenar modelos ML de valorizaciÃ³n</li>
                        <li>Generar scores de consolidaciÃ³n urbana</li>
                        <li>Emitir eventos <code>prediccion.lista</code></li>
                    </ul>
                    <p style="margin-top: 15px;"><strong>Herramientas:</strong> Prophet, Scikit-learn, XGBoost, SHAP</p>
                </div>
                
                <div class="agent-card">
                    <h4><span class="icon">âš–ï¸</span> Agente Regulatorio (RegulatoryAgent)</h4>
                    <p><strong>Rol:</strong> AnÃ¡lisis de normativa urbanÃ­stica y cumplimiento legal.</p>
                    <p><strong>Responsabilidades:</strong></p>
                    <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                        <li>Consultar RAG sobre Ley 21.713, LGUC, OGUC</li>
                        <li>Validar cumplimiento de PRC Pudahuel</li>
                        <li>Detectar conflictos normativos en predios</li>
                        <li>Generar alertas para AsesorÃ­a JurÃ­dica</li>
                        <li>Emitir eventos <code>normativa.alerta</code></li>
                    </ul>
                    <p style="margin-top: 15px;"><strong>Herramientas:</strong> ChromaDB RAG, RLM Engine, LangChain</p>
                </div>
                
                <div class="agent-card">
                    <h4><span class="icon">ğŸ—ºï¸</span> Agente de VisualizaciÃ³n (VisualizationAgent)</h4>
                    <p><strong>Rol:</strong> GeneraciÃ³n de mapas, grÃ¡ficos y reportes visuales.</p>
                    <p><strong>Responsabilidades:</strong></p>
                    <ul style="margin: 10px 0 0 20px; line-height: 1.8;">
                        <li>Renderizar mapas temÃ¡ticos con PostGIS</li>
                        <li>Generar heatmaps de valorizaciÃ³n</li>
                        <li>Crear dashboards interactivos</li>
                        <li>Exportar reportes PDF/Excel</li>
                        <li>Emitir eventos <code>reporte.generado</code></li>
                    </ul>
                    <p style="margin-top: 15px;"><strong>Herramientas:</strong> Plotly, Folium, python-docx, ReportLab</p>
                </div>
            </div>
            
            <h3>4.2 Flujo de InformaciÃ³n entre Agentes</h3>
            
            <div class="diagram">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              FLUJO DE INFORMACIÃ“N ENTRE AGENTES M07-PU                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                                                 â”‚
â”‚   SOLICITUD USUARIO                                                                                             â”‚
â”‚   "Calcular plusvalÃ­a de Pudahuel sector Lo Prado 2020-2025 y proyectar a 2027"                                â”‚
â”‚          â”‚                                                                                                      â”‚
â”‚          â–¼                                                                                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚                               ORQUESTADOR (RLM Engine)                                               â”‚     â”‚
â”‚   â”‚   â€¢ Descompone la solicitud en subtareas                                                             â”‚     â”‚
â”‚   â”‚   â€¢ Asigna agentes segÃºn competencias                                                                â”‚     â”‚
â”‚   â”‚   â€¢ Coordina ejecuciÃ³n paralela/secuencial                                                           â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚          â”‚                                                                                                      â”‚
â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚          â”‚                                                                     â”‚                               â”‚
â”‚          â–¼                                                                     â–¼                               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚   â”‚  PASO 1: DataAgent       â”‚                                    â”‚  PASO 1b: RegulatoryAgentâ”‚                â”‚
â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚                                    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                â”‚
â”‚   â”‚  â€¢ Obtener transacciones â”‚                                    â”‚  â€¢ Consultar PRC Pudahuelâ”‚                â”‚
â”‚   â”‚    SII 2020-2025         â”‚                                    â”‚  â€¢ Verificar zonas       â”‚                â”‚
â”‚   â”‚  â€¢ Scraping portales     â”‚                                    â”‚  â€¢ Detectar restriccionesâ”‚                â”‚
â”‚   â”‚  â€¢ Validar datos         â”‚                                    â”‚                          â”‚                â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                â”‚                                                               â”‚                               â”‚
â”‚                â”‚  Event: datos.actualizados                                    â”‚  Event: normativa.validada    â”‚
â”‚                â”‚                                                               â”‚                               â”‚
â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â”‚                                            â”‚                                                                    â”‚
â”‚                                            â–¼                                                                    â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                      â”‚
â”‚                              â”‚  PASO 2: ModelAgent      â”‚                                                      â”‚
â”‚                              â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚                                                      â”‚
â”‚                              â”‚  â€¢ Calcular plusvalÃ­a    â”‚                                                      â”‚
â”‚                              â”‚    histÃ³rica (Ley 21.713)â”‚                                                      â”‚
â”‚                              â”‚  â€¢ Entrenar Prophet      â”‚                                                      â”‚
â”‚                              â”‚  â€¢ Proyectar a 2027      â”‚                                                      â”‚
â”‚                              â”‚  â€¢ Generar intervalos    â”‚                                                      â”‚
â”‚                              â”‚    de confianza          â”‚                                                      â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                      â”‚
â”‚                                           â”‚                                                                     â”‚
â”‚                                           â”‚  Event: prediccion.lista                                            â”‚
â”‚                                           â”‚                                                                     â”‚
â”‚                                           â–¼                                                                     â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                      â”‚
â”‚                              â”‚ PASO 3: VisualizationAgentâ”‚                                                      â”‚
â”‚                              â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                                                      â”‚
â”‚                              â”‚  â€¢ Generar mapa heatmap  â”‚                                                      â”‚
â”‚                              â”‚  â€¢ Crear grÃ¡fico serie   â”‚                                                      â”‚
â”‚                              â”‚    temporal              â”‚                                                      â”‚
â”‚                              â”‚  â€¢ Generar reporte PDF   â”‚                                                      â”‚
â”‚                              â”‚    para SECPLAC          â”‚                                                      â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                      â”‚
â”‚                                           â”‚                                                                     â”‚
â”‚                                           â”‚  Event: reporte.generado                                            â”‚
â”‚                                           â”‚                                                                     â”‚
â”‚                                           â–¼                                                                     â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚                                    RESPUESTA AL USUARIO                                              â”‚     â”‚
â”‚   â”‚   {                                                                                                  â”‚     â”‚
â”‚   â”‚     "plusvalia_2020_2025": {"porcentaje": 45.2, "uf_m2_inicial": 15.3, "uf_m2_final": 22.2},        â”‚     â”‚
â”‚   â”‚     "proyeccion_2027": {"valor_esperado": 26.1, "intervalo_95": [23.5, 28.7]},                      â”‚     â”‚
â”‚   â”‚     "mapa_url": "/api/v1/mapas/plusvalia/pudahuel-2025",                                            â”‚     â”‚
â”‚   â”‚     "reporte_pdf": "/api/v1/reportes/plusvalia/pudahuel-2025.pdf"                                   â”‚     â”‚
â”‚   â”‚   }                                                                                                  â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            </div>
            
            <h3>4.3 Arquitectura LÃ³gica Integrada</h3>
            
            <div class="diagram">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          ARQUITECTURA LÃ“GICA M07-PU DENTRO DE DATAPOLIS AI                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                    CAPA DE PRESENTACIÃ“N                                                  â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚   â”‚
â”‚  â”‚   â”‚  Dashboard     â”‚  â”‚  Panel         â”‚  â”‚  Visor         â”‚  â”‚  Reportes      â”‚                        â”‚   â”‚
â”‚  â”‚   â”‚  AlcaldÃ­a      â”‚  â”‚  SECPLAC       â”‚  â”‚  DOM           â”‚  â”‚  JurÃ­dica      â”‚                        â”‚   â”‚
â”‚  â”‚   â”‚  (ejecutivo)   â”‚  â”‚  (mapas)       â”‚  â”‚  (permisos)    â”‚  â”‚  (conflictos)  â”‚                        â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚   â”‚
â”‚  â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                  â”‚                                                                              â”‚
â”‚                                  â–¼                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                    FASTAPI REST API                                                      â”‚   â”‚
â”‚  â”‚   /api/v1/plusvalia/                                                                                    â”‚   â”‚
â”‚  â”‚   â”œâ”€â”€ /calcular          POST   # Calcular plusvalÃ­a de zona/predio                                     â”‚   â”‚
â”‚  â”‚   â”œâ”€â”€ /proyectar         POST   # ProyecciÃ³n temporal con ML                                            â”‚   â”‚
â”‚  â”‚   â”œâ”€â”€ /mapa/{zona_id}    GET    # Obtener mapa temÃ¡tico                                                 â”‚   â”‚
â”‚  â”‚   â”œâ”€â”€ /indicadores       GET    # KPIs consolidados                                                     â”‚   â”‚
â”‚  â”‚   â”œâ”€â”€ /reporte           POST   # Generar reporte PDF/Excel                                             â”‚   â”‚
â”‚  â”‚   â”œâ”€â”€ /alertas           GET    # Alertas de cambios significativos                                     â”‚   â”‚
â”‚  â”‚   â”œâ”€â”€ /historico         GET    # Series temporales histÃ³ricas                                          â”‚   â”‚
â”‚  â”‚   â””â”€â”€ /comparativa       GET    # Benchmarking inter-comunal                                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                  â”‚                                                                              â”‚
â”‚                                  â–¼                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                              CAPA DE AGENTES (M07_PlusvaliaUrbanaModule)                                 â”‚   â”‚
â”‚  â”‚                                                                                                         â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚   â”‚
â”‚  â”‚   â”‚  DataAgent    â”‚    â”‚  ModelAgent   â”‚    â”‚ Regulatory    â”‚    â”‚ Visualization â”‚                      â”‚   â”‚
â”‚  â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚    â”‚    Agent      â”‚    â”‚    Agent      â”‚                      â”‚   â”‚
â”‚  â”‚   â”‚ â€¢ SII API     â”‚    â”‚ â€¢ Prophet     â”‚    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚    â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                      â”‚   â”‚
â”‚  â”‚   â”‚ â€¢ CBR API     â”‚    â”‚ â€¢ XGBoost     â”‚    â”‚ â€¢ RAG LGUC    â”‚    â”‚ â€¢ Plotly      â”‚                      â”‚   â”‚
â”‚  â”‚   â”‚ â€¢ Scrapers    â”‚    â”‚ â€¢ ARIMA       â”‚    â”‚ â€¢ RAG OGUC    â”‚    â”‚ â€¢ Folium      â”‚                      â”‚   â”‚
â”‚  â”‚   â”‚ â€¢ Validators  â”‚    â”‚ â€¢ PlusvalÃ­a   â”‚    â”‚ â€¢ PRC Parser  â”‚    â”‚ â€¢ ReportLab   â”‚                      â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚   â”‚
â”‚  â”‚           â”‚                    â”‚                    â”‚                    â”‚                               â”‚   â”‚
â”‚  â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚   â”‚
â”‚  â”‚                                â”‚                    â”‚                                                    â”‚   â”‚
â”‚  â”‚                                â–¼                    â–¼                                                    â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚   â”‚                           EVENT BUS (Redis Pub/Sub)                                              â”‚  â”‚   â”‚
â”‚  â”‚   â”‚   datos.actualizados | prediccion.lista | normativa.alerta | reporte.generado | alerta.plusvalia â”‚  â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                  â”‚                                                                              â”‚
â”‚                                  â–¼                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                    CAPA CORE                                                             â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚   â”‚
â”‚  â”‚   â”‚    RLM Engine     â”‚  â”‚   Memory Manager  â”‚  â”‚    LLM Layer      â”‚                                   â”‚   â”‚
â”‚  â”‚   â”‚   1M+ tokens      â”‚  â”‚   5 niveles       â”‚  â”‚   Ollama local    â”‚                                   â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                  â”‚                                                                              â”‚
â”‚                                  â–¼                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                    CAPA DE DATOS                                                         â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚   â”‚
â”‚  â”‚   â”‚   PostgreSQL      â”‚  â”‚      Redis        â”‚  â”‚    ChromaDB       â”‚                                   â”‚   â”‚
â”‚  â”‚   â”‚   + PostGIS       â”‚  â”‚     Cache         â”‚  â”‚   Embeddings      â”‚                                   â”‚   â”‚
â”‚  â”‚   â”‚ (datos espaciales)â”‚  â”‚ (sesiones,eventos)â”‚  â”‚ (RAG normativa)   â”‚                                   â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            </div>
        </section>
        
        <!-- SECCIÃ“N 5: MODELO DE DATOS -->
        <section class="section" id="modelo-datos">
            <h2>ğŸ—ƒï¸ 5. MODELO DE DATOS PROPUESTO</h2>
            
            <div class="alert alert-info">
                <strong>ğŸ“Œ VerificaciÃ³n:</strong> No se encontrÃ³ diseÃ±o previo de BD en el historial. Se propone modelo inicial hÃ­brido (relacional + geoespacial).
            </div>
            
            <h3>5.1 Tipo de Base de Datos Recomendada</h3>
            
            <div class="grid-3">
                <div class="card" style="border-color: #22c55e; border-width: 3px;">
                    <h4 style="color: #22c55e;">âœ… OpciÃ³n Recomendada</h4>
                    <p><strong>PostgreSQL + PostGIS</strong></p>
                    <ul style="margin: 10px 0 0 15px; font-size: 0.9rem; line-height: 1.8;">
                        <li>Soporte nativo geoespacial</li>
                        <li>ACID compliance</li>
                        <li>Extensiones ML (pg_ml)</li>
                        <li>IntegraciÃ³n con QGIS</li>
                        <li>Open source, maduro</li>
                    </ul>
                    <p style="margin-top: 10px; color: #22c55e;"><strong>Para DATAPOLIS AI: Ideal</strong></p>
                </div>
                <div class="card">
                    <h4>âš¡ OpciÃ³n Alternativa A</h4>
                    <p><strong>MongoDB + GeoJSON</strong></p>
                    <ul style="margin: 10px 0 0 15px; font-size: 0.9rem; line-height: 1.8;">
                        <li>Flexibilidad esquema</li>
                        <li>Ãndices geoespaciales</li>
                        <li>Escalabilidad horizontal</li>
                        <li>Bueno para documentos</li>
                    </ul>
                    <p style="margin-top: 10px; color: #d97706;"><strong>Desventaja:</strong> Menos potente para anÃ¡lisis espacial complejo</p>
                </div>
                <div class="card">
                    <h4>ğŸ”„ OpciÃ³n Alternativa B</h4>
                    <p><strong>HÃ­brido: PostgreSQL + TimescaleDB</strong></p>
                    <ul style="margin: 10px 0 0 15px; font-size: 0.9rem; line-height: 1.8;">
                        <li>Series temporales optimizadas</li>
                        <li>CompresiÃ³n nativa</li>
                        <li>Agregaciones rÃ¡pidas</li>
                        <li>Compatible PostGIS</li>
                    </ul>
                    <p style="margin-top: 10px; color: #0891b2;"><strong>Para:</strong> Si el volumen de datos histÃ³ricos es muy alto</p>
                </div>
            </div>
            
            <h3>5.2 Entidades Principales</h3>
            
            <div class="file-header">
                <span>ğŸ“ models/plusvalia_urbana.py</span>
                <span class="lang">Python / SQLModel</span>
            </div>
            <div class="code-block">
"""
================================================================================
MODELOS DE DATOS - MÃ“DULO PLUSVALÃAS URBANAS (M07-PU)
================================================================================
Base de datos: PostgreSQL + PostGIS
ORM: SQLModel (SQLAlchemy + Pydantic)
"""

from sqlmodel import SQLModel, Field, Relationship
from typing import Optional, List
from datetime import datetime, date
from decimal import Decimal
from geoalchemy2 import Geometry
from sqlalchemy import Column, Index
import uuid


# =============================================================================
# ENTIDADES GEOGRÃFICAS
# =============================================================================

class Comuna(SQLModel, table=True):
    """Comuna/Municipio"""
    __tablename__ = "comunas"
    
    id: int = Field(default=None, primary_key=True)
    codigo_ine: str = Field(max_length=5, unique=True, index=True)  # Ej: "13119" (Pudahuel)
    nombre: str = Field(max_length=100)
    region_id: int = Field(foreign_key="regiones.id")
    superficie_km2: Decimal = Field(default=0, decimal_places=2)
    poblacion: int = Field(default=0)
    
    # GeometrÃ­a (PostGIS)
    geometry: Optional[str] = Field(sa_column=Column(Geometry("MULTIPOLYGON", srid=4326)))
    
    # Relaciones
    manzanas: List["Manzana"] = Relationship(back_populates="comuna")
    predios: List["Predio"] = Relationship(back_populates="comuna")


class Manzana(SQLModel, table=True):
    """Manzana censal (unidad mÃ­nima de anÃ¡lisis)"""
    __tablename__ = "manzanas"
    
    id: int = Field(default=None, primary_key=True)
    codigo_manzana: str = Field(max_length=20, unique=True, index=True)
    comuna_id: int = Field(foreign_key="comunas.id")
    distrito_censal: str = Field(max_length=10)
    zona_censal: str = Field(max_length=10)
    
    # GeometrÃ­a
    geometry: Optional[str] = Field(sa_column=Column(Geometry("POLYGON", srid=4326)))
    centroid: Optional[str] = Field(sa_column=Column(Geometry("POINT", srid=4326)))
    
    # MÃ©tricas agregadas (calculadas)
    superficie_m2: Decimal = Field(default=0)
    num_predios: int = Field(default=0)
    valor_promedio_uf_m2: Decimal = Field(default=0, decimal_places=2)
    indice_consolidacion: Decimal = Field(default=0, decimal_places=2)  # 0-100
    
    # Relaciones
    comuna: Optional[Comuna] = Relationship(back_populates="manzanas")
    predios: List["Predio"] = Relationship(back_populates="manzana")
    valoraciones: List["ValoracionManzana"] = Relationship(back_populates="manzana")


class Predio(SQLModel, table=True):
    """Predio individual (rol SII)"""
    __tablename__ = "predios"
    
    id: int = Field(default=None, primary_key=True)
    rol_sii: str = Field(max_length=20, unique=True, index=True)  # Ej: "13119-00123"
    comuna_id: int = Field(foreign_key="comunas.id")
    manzana_id: Optional[int] = Field(foreign_key="manzanas.id")
    
    # IdentificaciÃ³n
    direccion: str = Field(max_length=255)
    numero: Optional[str] = Field(max_length=20)
    
    # CaracterÃ­sticas fÃ­sicas
    superficie_terreno_m2: Decimal = Field(default=0, decimal_places=2)
    superficie_construida_m2: Decimal = Field(default=0, decimal_places=2)
    tipo_predio: str = Field(max_length=50)  # "sitio_eriazo", "casa", "edificio", "agricola"
    destino: str = Field(max_length=50)  # "habitacional", "comercial", "industrial", "mixto"
    
    # AvalÃºo SII
    avaluo_fiscal_uf: Decimal = Field(default=0, decimal_places=2)
    fecha_avaluo: Optional[date] = None
    
    # GeometrÃ­a
    geometry: Optional[str] = Field(sa_column=Column(Geometry("POLYGON", srid=4326)))
    
    # Relaciones
    comuna: Optional[Comuna] = Relationship(back_populates="predios")
    manzana: Optional[Manzana] = Relationship(back_populates="predios")
    transacciones: List["TransaccionInmobiliaria"] = Relationship(back_populates="predio")
    permisos: List["PermisoEdificacion"] = Relationship(back_populates="predio")
    valoraciones: List["ValoracionPredio"] = Relationship(back_populates="predio")


# =============================================================================
# ENTIDADES DE TRANSACCIONES Y MERCADO
# =============================================================================

class TransaccionInmobiliaria(SQLModel, table=True):
    """TransacciÃ³n de compraventa registrada"""
    __tablename__ = "transacciones_inmobiliarias"
    
    id: int = Field(default=None, primary_key=True)
    predio_id: int = Field(foreign_key="predios.id", index=True)
    
    # Datos de la transacciÃ³n
    fecha_transaccion: date = Field(index=True)
    tipo_transaccion: str = Field(max_length=50)  # "compraventa", "herencia", "adjudicacion"
    monto_uf: Decimal = Field(decimal_places=2)
    monto_clp: int
    
    # Datos de inscripciÃ³n
    foja: Optional[int] = None
    numero_inscripcion: Optional[int] = None
    anio_inscripcion: Optional[int] = None
    conservador: Optional[str] = Field(max_length=100)
    
    # Calculados
    precio_uf_m2: Decimal = Field(default=0, decimal_places=2)
    
    # RelaciÃ³n
    predio: Optional[Predio] = Relationship(back_populates="transacciones")
    
    __table_args__ = (
        Index("ix_transacciones_fecha_comuna", "fecha_transaccion", "predio_id"),
    )


class OfertaInmobiliaria(SQLModel, table=True):
    """Oferta de venta/arriendo en portales"""
    __tablename__ = "ofertas_inmobiliarias"
    
    id: int = Field(default=None, primary_key=True)
    predio_id: Optional[int] = Field(foreign_key="predios.id")
    
    # IdentificaciÃ³n
    fuente: str = Field(max_length=50)  # "portalinmobiliario", "yapo", "toctoc"
    url_original: str = Field(max_length=500)
    fecha_publicacion: date
    fecha_scraping: datetime = Field(default_factory=datetime.utcnow)
    
    # Datos de la oferta
    tipo_operacion: str = Field(max_length=20)  # "venta", "arriendo"
    precio_uf: Decimal = Field(decimal_places=2)
    precio_clp: int
    
    # UbicaciÃ³n
    comuna_nombre: str = Field(max_length=100)
    direccion_aproximada: str = Field(max_length=255)
    latitud: Optional[Decimal] = Field(decimal_places=6)
    longitud: Optional[Decimal] = Field(decimal_places=6)
    
    # CaracterÃ­sticas
    superficie_m2: Decimal = Field(default=0, decimal_places=2)
    dormitorios: Optional[int] = None
    banos: Optional[int] = None
    tipo_propiedad: str = Field(max_length=50)
    
    # Calculados
    precio_uf_m2: Decimal = Field(default=0, decimal_places=2)
    activo: bool = Field(default=True)


# =============================================================================
# ENTIDADES DE PLUSVALÃA Y VALORACIÃ“N
# =============================================================================

class ValoracionManzana(SQLModel, table=True):
    """ValoraciÃ³n histÃ³rica por manzana (serie temporal)"""
    __tablename__ = "valoraciones_manzana"
    
    id: int = Field(default=None, primary_key=True)
    manzana_id: int = Field(foreign_key="manzanas.id", index=True)
    
    # PerÃ­odo
    fecha: date = Field(index=True)  # Primer dÃ­a del mes
    periodo: str = Field(max_length=7)  # "2025-01"
    
    # Valores calculados
    valor_promedio_uf_m2: Decimal = Field(decimal_places=2)
    valor_mediana_uf_m2: Decimal = Field(decimal_places=2)
    valor_minimo_uf_m2: Decimal = Field(decimal_places=2)
    valor_maximo_uf_m2: Decimal = Field(decimal_places=2)
    desviacion_estandar: Decimal = Field(decimal_places=2)
    
    # PlusvalÃ­a
    plusvalia_mensual_pct: Decimal = Field(default=0, decimal_places=2)
    plusvalia_anual_pct: Decimal = Field(default=0, decimal_places=2)
    plusvalia_acumulada_pct: Decimal = Field(default=0, decimal_places=2)
    
    # Metadata
    num_transacciones: int = Field(default=0)
    num_ofertas: int = Field(default=0)
    confianza: Decimal = Field(default=0, decimal_places=2)  # 0-1
    
    # RelaciÃ³n
    manzana: Optional[Manzana] = Relationship(back_populates="valoraciones")
    
    __table_args__ = (
        Index("ix_valoraciones_manzana_periodo", "manzana_id", "periodo", unique=True),
    )


class ValoracionPredio(SQLModel, table=True):
    """ValoraciÃ³n especÃ­fica de un predio"""
    __tablename__ = "valoraciones_predio"
    
    id: int = Field(default=None, primary_key=True)
    predio_id: int = Field(foreign_key="predios.id", index=True)
    
    # PerÃ­odo
    fecha_valoracion: date = Field(index=True)
    
    # Valores
    valor_estimado_uf: Decimal = Field(decimal_places=2)
    valor_uf_m2: Decimal = Field(decimal_places=2)
    metodo_valoracion: str = Field(max_length=50)  # "mercado", "hedonic", "ml"
    
    # PlusvalÃ­a respecto a valor anterior
    plusvalia_pct: Decimal = Field(default=0, decimal_places=2)
    
    # Intervalos de confianza
    valor_minimo_uf: Decimal = Field(decimal_places=2)
    valor_maximo_uf: Decimal = Field(decimal_places=2)
    confianza: Decimal = Field(default=0, decimal_places=2)
    
    # RelaciÃ³n
    predio: Optional[Predio] = Relationship(back_populates="valoraciones")


class CalculoPlusvalia(SQLModel, table=True):
    """CÃ¡lculo de plusvalÃ­a segÃºn Ley 21.713"""
    __tablename__ = "calculos_plusvalia"
    
    id: int = Field(default=None, primary_key=True)
    uuid: str = Field(default_factory=lambda: str(uuid.uuid4()), unique=True)
    predio_id: int = Field(foreign_key="predios.id", index=True)
    
    # PerÃ­odo de anÃ¡lisis
    fecha_inicio: date
    fecha_fin: date
    
    # Valores base
    valor_inicial_uf: Decimal = Field(decimal_places=2)
    valor_final_uf: Decimal = Field(decimal_places=2)
    
    # Ajustes segÃºn Ley 21.713
    ajuste_ipc: Decimal = Field(decimal_places=2)  # CorrecciÃ³n monetaria
    ajuste_mejoras: Decimal = Field(decimal_places=2)  # Deducciones permitidas
    ajuste_depreciacion: Decimal = Field(decimal_places=2)
    
    # PlusvalÃ­a calculada
    plusvalia_bruta_uf: Decimal = Field(decimal_places=2)
    plusvalia_neta_uf: Decimal = Field(decimal_places=2)
    plusvalia_pct: Decimal = Field(decimal_places=2)
    
    # Impuesto (si aplica)
    base_imponible_uf: Decimal = Field(decimal_places=2)
    tasa_impuesto: Decimal = Field(decimal_places=2)  # Ej: 0.10 (10%)
    impuesto_estimado_uf: Decimal = Field(decimal_places=2)
    
    # Metadata
    fecha_calculo: datetime = Field(default_factory=datetime.utcnow)
    calculado_por: str = Field(max_length=100)  # "sistema", "usuario_xxx"
    version_ley: str = Field(default="21.713", max_length=20)


# =============================================================================
# ENTIDADES NORMATIVAS Y PERMISOS
# =============================================================================

class ZonificacionPRC(SQLModel, table=True):
    """ZonificaciÃ³n del Plan Regulador Comunal"""
    __tablename__ = "zonificacion_prc"
    
    id: int = Field(default=None, primary_key=True)
    comuna_id: int = Field(foreign_key="comunas.id")
    
    # IdentificaciÃ³n
    codigo_zona: str = Field(max_length=20)  # Ej: "ZU-1", "ZR-2"
    nombre_zona: str = Field(max_length=100)
    
    # ParÃ¡metros urbanÃ­sticos
    uso_suelo_principal: str = Field(max_length=50)
    usos_permitidos: str  # JSON array
    coef_constructibilidad: Decimal = Field(decimal_places=2)
    coef_ocupacion_suelo: Decimal = Field(decimal_places=2)
    altura_maxima_m: Decimal = Field(decimal_places=2)
    densidad_hab_ha: Optional[int] = None
    
    # GeometrÃ­a
    geometry: Optional[str] = Field(sa_column=Column(Geometry("MULTIPOLYGON", srid=4326)))
    
    # Vigencia
    fecha_vigencia: date
    instrumento: str = Field(max_length=100)  # "PRC Pudahuel 2020"


class PermisoEdificacion(SQLModel, table=True):
    """Permisos de edificaciÃ³n otorgados por DOM"""
    __tablename__ = "permisos_edificacion"
    
    id: int = Field(default=None, primary_key=True)
    predio_id: int = Field(foreign_key="predios.id", index=True)
    
    # IdentificaciÃ³n
    numero_permiso: str = Field(max_length=50)
    fecha_solicitud: date
    fecha_otorgamiento: Optional[date] = None
    
    # Tipo de obra
    tipo_obra: str = Field(max_length=50)  # "obra_nueva", "ampliacion", "regularizacion"
    destino: str = Field(max_length=50)
    
    # Superficies
    superficie_terreno_m2: Decimal = Field(decimal_places=2)
    superficie_construir_m2: Decimal = Field(decimal_places=2)
    pisos: int = Field(default=1)
    
    # Estado
    estado: str = Field(max_length=30)  # "tramite", "aprobado", "rechazado", "recepcionado"
    
    # RelaciÃ³n
    predio: Optional[Predio] = Relationship(back_populates="permisos")


# =============================================================================
# ENTIDADES DE PREDICCIÃ“N Y ANÃLISIS
# =============================================================================

class PrediccionPlusvalia(SQLModel, table=True):
    """Predicciones generadas por modelos ML"""
    __tablename__ = "predicciones_plusvalia"
    
    id: int = Field(default=None, primary_key=True)
    manzana_id: Optional[int] = Field(foreign_key="manzanas.id")
    predio_id: Optional[int] = Field(foreign_key="predios.id")
    
    # Modelo
    modelo: str = Field(max_length=50)  # "prophet", "arima", "xgboost"
    version_modelo: str = Field(max_length=20)
    
    # Horizonte
    fecha_prediccion: date  # CuÃ¡ndo se hizo la predicciÃ³n
    fecha_objetivo: date  # Para quÃ© fecha se predice
    horizonte_meses: int
    
    # Valores predichos
    valor_predicho_uf_m2: Decimal = Field(decimal_places=2)
    plusvalia_predicha_pct: Decimal = Field(decimal_places=2)
    
    # Intervalos de confianza
    intervalo_inf_80: Decimal = Field(decimal_places=2)
    intervalo_sup_80: Decimal = Field(decimal_places=2)
    intervalo_inf_95: Decimal = Field(decimal_places=2)
    intervalo_sup_95: Decimal = Field(decimal_places=2)
    
    # MÃ©tricas del modelo
    rmse: Decimal = Field(decimal_places=4)
    mape: Decimal = Field(decimal_places=4)


class AlertaPlusvalia(SQLModel, table=True):
    """Alertas de cambios significativos"""
    __tablename__ = "alertas_plusvalia"
    
    id: int = Field(default=None, primary_key=True)
    uuid: str = Field(default_factory=lambda: str(uuid.uuid4()), unique=True)
    
    # UbicaciÃ³n
    manzana_id: Optional[int] = Field(foreign_key="manzanas.id")
    predio_id: Optional[int] = Field(foreign_key="predios.id")
    
    # Tipo de alerta
    tipo_alerta: str = Field(max_length=50)  # "plusvalia_alta", "caida_valor", "anomalia"
    severidad: str = Field(max_length=20)  # "info", "warning", "critical"
    
    # DescripciÃ³n
    titulo: str = Field(max_length=200)
    descripcion: str
    
    # Valores
    valor_detectado: Decimal = Field(decimal_places=2)
    valor_umbral: Decimal = Field(decimal_places=2)
    desviacion_pct: Decimal = Field(decimal_places=2)
    
    # Estado
    fecha_creacion: datetime = Field(default_factory=datetime.utcnow)
    estado: str = Field(default="activa", max_length=20)  # "activa", "revisada", "resuelta"
    revisado_por: Optional[str] = Field(max_length=100)
    fecha_revision: Optional[datetime] = None
    
    # Destinatarios
    unidad_municipal: str = Field(max_length=50)  # "SECPLAC", "DOM", "ALCALDIA", "JURIDICA"
</div>
            
            <h3>5.3 Diagrama Entidad-RelaciÃ³n</h3>
            
            <div class="diagram">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              DIAGRAMA ENTIDAD-RELACIÃ“N - PLUSVALÃAS URBANAS                                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                                                 â”‚
â”‚                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                     â”‚
â”‚                                         â”‚     REGION      â”‚                                                     â”‚
â”‚                                         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                                                     â”‚
â”‚                                         â”‚ PK id           â”‚                                                     â”‚
â”‚                                         â”‚    nombre       â”‚                                                     â”‚
â”‚                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                     â”‚
â”‚                                                  â”‚ 1                                                            â”‚
â”‚                                                  â”‚                                                              â”‚
â”‚                                                  â”‚ N                                                            â”‚
â”‚                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                                                     â”‚
â”‚                                         â”‚     COMUNA      â”‚                                                     â”‚
â”‚                                         â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                                                     â”‚
â”‚                                         â”‚ PK id           â”‚                                                     â”‚
â”‚                                         â”‚ FK region_id    â”‚                                                     â”‚
â”‚                                         â”‚    codigo_ine   â”‚                                                     â”‚
â”‚                                         â”‚    nombre       â”‚                                                     â”‚
â”‚                                         â”‚    geometry ğŸŒ  â”‚                                                     â”‚
â”‚                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                     â”‚
â”‚                                                  â”‚ 1                                                            â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚                              â”‚                   â”‚                   â”‚                                          â”‚
â”‚                              â”‚ N                 â”‚ N                 â”‚ N                                        â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚                     â”‚    MANZANA      â”‚ â”‚    PREDIO      â”‚ â”‚  ZONIFICACION   â”‚                                 â”‚
â”‚                     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚     PRC         â”‚                                 â”‚
â”‚                     â”‚ PK id           â”‚ â”‚ PK id           â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚                                 â”‚
â”‚                     â”‚ FK comuna_id    â”‚ â”‚ FK comuna_id    â”‚ â”‚ PK id           â”‚                                 â”‚
â”‚                     â”‚    codigo_manz. â”‚ â”‚ FK manzana_id   â”‚ â”‚ FK comuna_id    â”‚                                 â”‚
â”‚                     â”‚    geometry ğŸŒ  â”‚ â”‚    rol_sii      â”‚ â”‚    codigo_zona  â”‚                                 â”‚
â”‚                     â”‚    indice_cons. â”‚ â”‚    direccion    â”‚ â”‚    coef_constr. â”‚                                 â”‚
â”‚                     â”‚    valor_prom.  â”‚ â”‚    superficie   â”‚ â”‚    geometry ğŸŒ  â”‚                                 â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    avaluo_uf    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                              â”‚          â”‚    geometry ğŸŒ  â”‚                                                     â”‚
â”‚                              â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                     â”‚
â”‚                              â”‚ 1                 â”‚ 1                                                            â”‚
â”‚                              â”‚                   â”‚                                                              â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚                                                              â”‚
â”‚                     â”‚  VALORACION     â”‚          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚                     â”‚   MANZANA       â”‚          â”‚ N               â”‚ N               â”‚ N                        â”‚
â”‚                     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚                     â”‚ PK id           â”‚ â”‚ TRANSACCION    â”‚ â”‚  PERMISO     â”‚ â”‚ VALORACION     â”‚                 â”‚
â”‚                     â”‚ FK manzana_id   â”‚ â”‚ INMOBILIARIA   â”‚ â”‚ EDIFICACION  â”‚ â”‚   PREDIO       â”‚                 â”‚
â”‚                     â”‚    fecha        â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                 â”‚
â”‚                     â”‚    periodo      â”‚ â”‚ PK id           â”‚ â”‚ PK id        â”‚ â”‚ PK id          â”‚                 â”‚
â”‚                     â”‚    valor_prom.  â”‚ â”‚ FK predio_id    â”‚ â”‚ FK predio_id â”‚ â”‚ FK predio_id   â”‚                 â”‚
â”‚                     â”‚    plusvalia_%  â”‚ â”‚    fecha        â”‚ â”‚    numero    â”‚ â”‚    fecha       â”‚                 â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    monto_uf     â”‚ â”‚    estado    â”‚ â”‚    valor_uf    â”‚                 â”‚
â”‚                                         â”‚    precio_uf_m2 â”‚ â”‚    tipo_obra â”‚ â”‚    plusvalia_% â”‚                 â”‚
â”‚                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                                                                 â”‚
â”‚  LEYENDA:                                                                                                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                                                                      â”‚
â”‚  PK = Primary Key    FK = Foreign Key    ğŸŒ = Columna PostGIS (Geometry)                                        â”‚
â”‚  1â”€â”€â”€N = RelaciÃ³n uno a muchos                                                                                  â”‚
â”‚                                                                                                                 â”‚
â”‚  ENTIDADES ADICIONALES (no mostradas por espacio):                                                              â”‚
â”‚  â€¢ OfertaInmobiliaria: Datos de portales inmobiliarios                                                          â”‚
â”‚  â€¢ CalculoPlusvalia: CÃ¡lculos segÃºn Ley 21.713                                                                  â”‚
â”‚  â€¢ PrediccionPlusvalia: Proyecciones ML                                                                         â”‚
â”‚  â€¢ AlertaPlusvalia: Alertas para unidades municipales                                                           â”‚
â”‚                                                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            </div>
        </section>
        
        <!-- SECCIÃ“N 6: CASO MUNICIPIO PUDAHUEL -->
        <section class="section" id="pudahuel">
            <h2>ğŸ›ï¸ 6. CASO DE USO: MUNICIPIO DE PUDAHUEL</h2>
            
            <div class="alert alert-success">
                <strong>ğŸ¯ Objetivo Municipal:</strong> Herramienta de monitoreo y prospectiva territorial que consolide informaciÃ³n pÃºblica/privada para apoyar decisiones sobre consolidaciÃ³n urbana, inversiones, valores de activos y gestiÃ³n normativa.
            </div>
            
            <h3>6.1 Funcionalidades por Unidad Municipal</h3>
            
            <div class="grid-2">
                <div class="card" style="border-left: 4px solid #7c3aed;">
                    <h4>ğŸ“Š SECPLAC (SecretarÃ­a Comunal de PlanificaciÃ³n)</h4>
                    <p><strong>Necesidades:</strong></p>
                    <ul style="margin: 10px 0 0 15px; line-height: 1.8;">
                        <li>Mapas de consolidaciÃ³n urbana por sector</li>
                        <li>Proyecciones de crecimiento poblacional y habitacional</li>
                        <li>AnÃ¡lisis de brechas de equipamiento vs. densificaciÃ³n</li>
                        <li>Monitoreo de inversiones pÃºblicas/privadas</li>
                        <li>Indicadores para PLADECO y PRC</li>
                    </ul>
                    <p style="margin-top: 15px;"><strong>Entregables M07-PU:</strong></p>
                    <ul style="margin: 10px 0 0 15px; line-height: 1.8;">
                        <li>âœ… Dashboard de indicadores territoriales</li>
                        <li>âœ… Mapas temÃ¡ticos (valores, plusvalÃ­a, densidad)</li>
                        <li>âœ… Reportes mensuales automatizados</li>
                        <li>âœ… Alertas de zonas con cambios significativos</li>
                    </ul>
                </div>
                
                <div class="card" style="border-left: 4px solid #0891b2;">
                    <h4>ğŸ—ï¸ DOM (DirecciÃ³n de Obras Municipales)</h4>
                    <p><strong>Necesidades:</strong></p>
                    <ul style="margin: 10px 0 0 15px; line-height: 1.8;">
                        <li>DetecciÃ³n de construcciones sin permiso</li>
                        <li>AnÃ¡lisis de impacto de permisos en valorizaciÃ³n</li>
                        <li>VerificaciÃ³n de cumplimiento PRC</li>
                        <li>ProyecciÃ³n de demanda de permisos por zona</li>
                    </ul>
                    <p style="margin-top: 15px;"><strong>Entregables M07-PU:</strong></p>
                    <ul style="margin: 10px 0 0 15px; line-height: 1.8;">
                        <li>âœ… IntegraciÃ³n con M04 (detector satelital)</li>
                        <li>âœ… Alertas de construcciones irregulares</li>
                        <li>âœ… AnÃ¡lisis de potencial edificatorio</li>
                        <li>âœ… CorrelaciÃ³n permisos vs. plusvalÃ­a</li>
                    </ul>
                </div>
                
                <div class="card" style="border-left: 4px solid #059669;">
                    <h4>ğŸ›ï¸ ALCALDÃA</h4>
                    <p><strong>Necesidades:</strong></p>
                    <ul style="margin: 10px 0 0 15px; line-height: 1.8;">
                        <li>Dashboard ejecutivo con KPIs clave</li>
                        <li>VisiÃ³n consolidada del territorio</li>
                        <li>Alertas de inversiones y cambios relevantes</li>
                        <li>InformaciÃ³n para comunicaciÃ³n ciudadana</li>
                    </ul>
                    <p style="margin-top: 15px;"><strong>Entregables M07-PU:</strong></p>
                    <ul style="margin: 10px 0 0 15px; line-height: 1.8;">
                        <li>âœ… Panel ejecutivo simplificado</li>
                        <li>âœ… Comparativa con otras comunas</li>
                        <li>âœ… Resumen de inversiones y proyectos</li>
                        <li>âœ… Indicadores de gestiÃ³n territorial</li>
                    </ul>
                </div>
                
                <div class="card" style="border-left: 4px solid #d97706;">
                    <h4>âš–ï¸ ASESORÃA JURÃDICA</h4>
                    <p><strong>Necesidades:</strong></p>
                    <ul style="margin: 10px 0 0 15px; line-height: 1.8;">
                        <li>DetecciÃ³n de conflictos normativos</li>
                        <li>AnÃ¡lisis de casos para expropiaciones</li>
                        <li>EvaluaciÃ³n de impacto de cambios de zonificaciÃ³n</li>
                        <li>InformaciÃ³n para litigios territoriales</li>
                    </ul>
                    <p style="margin-top: 15px;"><strong>Entregables M07-PU:</strong></p>
                    <ul style="margin: 10px 0 0 15px; line-height: 1.8;">
                        <li>âœ… RAG sobre LGUC, OGUC, PRC</li>
                        <li>âœ… Alertas de inconsistencias normativas</li>
                        <li>âœ… Valoraciones para tasaciones legales</li>
                        <li>âœ… Historial de transacciones por predio</li>
                    </ul>
                </div>
            </div>
            
            <h3>6.2 Zonas de InterÃ©s EspecÃ­ficas en Pudahuel</h3>
            
            <table>
                <tr>
                    <th>Zona</th>
                    <th>CaracterÃ­sticas</th>
                    <th>AnÃ¡lisis Requerido</th>
                    <th>Prioridad</th>
                </tr>
                <tr>
                    <td><strong>Lo Aguirre</strong></td>
                    <td>Ãrea excluida de desarrollo urbano, proyectos inmobiliarios emergentes</td>
                    <td>ProyecciÃ³n de cambio de uso, impacto en valorizaciÃ³n</td>
                    <td><span class="badge badge-danger">CRÃTICA</span></td>
                </tr>
                <tr>
                    <td><strong>El Noviciado</strong></td>
                    <td>ExpansiÃ³n urbana, loteos irregulares histÃ³ricos</td>
                    <td>ConsolidaciÃ³n, regularizaciÃ³n, plusvalÃ­a potencial</td>
                    <td><span class="badge badge-danger">CRÃTICA</span></td>
                </tr>
                <tr>
                    <td><strong>Aeropuerto AMB</strong></td>
                    <td>Zona de influencia econÃ³mica y logÃ­stica</td>
                    <td>Impacto de inversiones, usos industriales vs. residenciales</td>
                    <td><span class="badge badge-warning">ALTA</span></td>
                </tr>
                <tr>
                    <td><strong>Ciudad de los Valles</strong></td>
                    <td>Desarrollo inmobiliario consolidado</td>
                    <td>Tendencias de mercado, proyecciones de valor</td>
                    <td><span class="badge badge-info">MEDIA</span></td>
                </tr>
                <tr>
                    <td><strong>Teniente Cruz</strong></td>
                    <td>Centro histÃ³rico, mixtura de usos</td>
                    <td>RenovaciÃ³n urbana, potencial de densificaciÃ³n</td>
                    <td><span class="badge badge-info">MEDIA</span></td>
                </tr>
            </table>
            
            <h3>6.3 Indicadores Clave para Pudahuel</h3>
            
            <div class="grid-3">
                <div class="entity-box">
                    <h5>ğŸ“ˆ EconÃ³micos</h5>
                    <ul style="margin: 10px 0 0 15px; font-size: 0.9rem; line-height: 1.8;">
                        <li>PlusvalÃ­a promedio anual (%)</li>
                        <li>Valor UF/mÂ² por sector</li>
                        <li>InversiÃ³n privada acumulada (UF)</li>
                        <li>RecaudaciÃ³n potencial impuesto</li>
                    </ul>
                </div>
                <div class="entity-box">
                    <h5>ğŸ—ï¸ FÃ­sico-Espaciales</h5>
                    <ul style="margin: 10px 0 0 15px; font-size: 0.9rem; line-height: 1.8;">
                        <li>Ãndice de consolidaciÃ³n (0-100)</li>
                        <li>Superficie construida nueva (mÂ²)</li>
                        <li>Densidad habitacional (hab/ha)</li>
                        <li>Cobertura de servicios (%)</li>
                    </ul>
                </div>
                <div class="entity-box">
                    <h5>ğŸ“Š GestiÃ³n</h5>
                    <ul style="margin: 10px 0 0 15px; font-size: 0.9rem; line-height: 1.8;">
                        <li>Permisos otorgados vs. recepcionados</li>
                        <li>Construcciones irregulares detectadas</li>
                        <li>Alertas generadas/resueltas</li>
                        <li>Tiempo promedio de trÃ¡mites</li>
                    </ul>
                </div>
            </div>
        </section>
        
        <!-- SECCIÃ“N 7: PLAN DE IMPLEMENTACIÃ“N -->
        <section class="section" id="implementacion">
            <h2>ğŸ“… 7. PLAN DE IMPLEMENTACIÃ“N POR ETAPAS</h2>
            
            <div class="alert alert-info">
                <strong>ğŸ¯ Enfoque:</strong> Desarrollo iterativo combinando Rutas 1, 2 y 3 en orden lÃ³gico de dependencias tÃ©cnicas.
            </div>
            
            <h3>ETAPA 1: Fundamentos (Semanas 1-3) - RUTA 1</h3>
            
            <table>
                <tr>
                    <th>Semana</th>
                    <th>Actividad</th>
                    <th>Entregable</th>
                    <th>Unidad Beneficiada</th>
                </tr>
                <tr>
                    <td><strong>1</strong></td>
                    <td>
                        â€¢ DiseÃ±o final modelo de datos<br>
                        â€¢ Configurar PostgreSQL + PostGIS<br>
                        â€¢ Crear migraciones Alembic
                    </td>
                    <td>
                        ğŸ“¦ BD con 15 tablas<br>
                        ğŸ“¦ Migraciones versionadas
                    </td>
                    <td>Todas</td>
                </tr>
                <tr>
                    <td><strong>2</strong></td>
                    <td>
                        â€¢ Implementar schemas Pydantic V2<br>
                        â€¢ Crear servicios CRUD base<br>
                        â€¢ Configurar docker-compose
                    </td>
                    <td>
                        ğŸ“¦ Schemas validaciÃ³n<br>
                        ğŸ“¦ CRUD operations<br>
                        ğŸ“¦ docker-compose.yml
                    </td>
                    <td>Todas</td>
                </tr>
                <tr>
                    <td><strong>3</strong></td>
                    <td>
                        â€¢ Integrar con Event Bus existente<br>
                        â€¢ Implementar tests unitarios<br>
                        â€¢ Cargar datos iniciales Pudahuel
                    </td>
                    <td>
                        ğŸ“¦ Eventos definidos<br>
                        ğŸ“¦ Tests (coverage 70%)<br>
                        ğŸ“¦ Seed data Pudahuel
                    </td>
                    <td>SECPLAC, DOM</td>
                </tr>
            </table>
            
            <h3>ETAPA 2: MÃ³dulo Core + Agentes (Semanas 4-8) - RUTA 2</h3>
            
            <table>
                <tr>
                    <th>Semana</th>
                    <th>Actividad</th>
                    <th>Entregable</th>
                    <th>Unidad Beneficiada</th>
                </tr>
                <tr>
                    <td><strong>4</strong></td>
                    <td>
                        â€¢ Implementar DataAgent<br>
                        â€¢ Conectores SII, CBR<br>
                        â€¢ Scrapers portales inmobiliarios
                    </td>
                    <td>
                        ğŸ“¦ data_agent.py<br>
                        ğŸ“¦ 3 conectores API<br>
                        ğŸ“¦ 2 scrapers
                    </td>
                    <td>SECPLAC</td>
                </tr>
                <tr>
                    <td><strong>5</strong></td>
                    <td>
                        â€¢ Implementar ModelAgent<br>
                        â€¢ FÃ³rmulas Ley 21.713<br>
                        â€¢ Modelo Prophet bÃ¡sico
                    </td>
                    <td>
                        ğŸ“¦ model_agent.py<br>
                        ğŸ“¦ CÃ¡lculo plusvalÃ­a<br>
                        ğŸ“¦ Prophet entrenado
                    </td>
                    <td>SECPLAC, JurÃ­dica</td>
                </tr>
                <tr>
                    <td><strong>6</strong></td>
                    <td>
                        â€¢ Implementar RegulatoryAgent<br>
                        â€¢ RAG sobre LGUC, OGUC, PRC<br>
                        â€¢ Integrar con RLM Engine
                    </td>
                    <td>
                        ğŸ“¦ regulatory_agent.py<br>
                        ğŸ“¦ ChromaDB con normativa<br>
                        ğŸ“¦ Consultas NLP
                    </td>
                    <td>JurÃ­dica, DOM</td>
                </tr>
                <tr>
                    <td><strong>7</strong></td>
                    <td>
                        â€¢ Implementar VisualizationAgent<br>
                        â€¢ Mapas PostGIS â†’ Folium<br>
                        â€¢ Reportes PDF automÃ¡ticos
                    </td>
                    <td>
                        ğŸ“¦ visualization_agent.py<br>
                        ğŸ“¦ Mapas temÃ¡ticos<br>
                        ğŸ“¦ Templates reportes
                    </td>
                    <td>AlcaldÃ­a, SECPLAC</td>
                </tr>
                <tr>
                    <td><strong>8</strong></td>
                    <td>
                        â€¢ Router FastAPI completo<br>
                        â€¢ OrquestaciÃ³n agentes<br>
                        â€¢ Tests de integraciÃ³n
                    </td>
                    <td>
                        ğŸ“¦ 20+ endpoints<br>
                        ğŸ“¦ Flujos multi-agente<br>
                        ğŸ“¦ Tests (coverage 80%)
                    </td>
                    <td>Todas</td>
                </tr>
            </table>
            
            <h3>ETAPA 3: Frontend + Deploy Pudahuel (Semanas 9-12) - RUTA 3</h3>
            
            <table>
                <tr>
                    <th>Semana</th>
                    <th>Actividad</th>
                    <th>Entregable</th>
                    <th>Unidad Beneficiada</th>
                </tr>
                <tr>
                    <td><strong>9</strong></td>
                    <td>
                        â€¢ DiseÃ±o UI/UX por unidad<br>
                        â€¢ Dashboard AlcaldÃ­a<br>
                        â€¢ Panel SECPLAC con mapas
                    </td>
                    <td>
                        ğŸ“¦ Wireframes validados<br>
                        ğŸ“¦ Dashboard ejecutivo<br>
                        ğŸ“¦ Visor mapas
                    </td>
                    <td>AlcaldÃ­a, SECPLAC</td>
                </tr>
                <tr>
                    <td><strong>10</strong></td>
                    <td>
                        â€¢ Panel DOM<br>
                        â€¢ Visor JurÃ­dica<br>
                        â€¢ Sistema de alertas
                    </td>
                    <td>
                        ğŸ“¦ Panel permisos<br>
                        ğŸ“¦ Consultor normativo<br>
                        ğŸ“¦ Notificaciones
                    </td>
                    <td>DOM, JurÃ­dica</td>
                </tr>
                <tr>
                    <td><strong>11</strong></td>
                    <td>
                        â€¢ Deploy en servidor municipal<br>
                        â€¢ ConfiguraciÃ³n producciÃ³n<br>
                        â€¢ CapacitaciÃ³n usuarios
                    </td>
                    <td>
                        ğŸ“¦ Sistema en producciÃ³n<br>
                        ğŸ“¦ DocumentaciÃ³n<br>
                        ğŸ“¦ 4 sesiones capacitaciÃ³n
                    </td>
                    <td>Todas</td>
                </tr>
                <tr>
                    <td><strong>12</strong></td>
                    <td>
                        â€¢ Ajustes post-feedback<br>
                        â€¢ DocumentaciÃ³n final<br>
                        â€¢ Entrega formal
                    </td>
                    <td>
                        ğŸ“¦ Sistema ajustado<br>
                        ğŸ“¦ Manual de usuario<br>
                        ğŸ“¦ Acta de entrega
                    </td>
                    <td>Todas</td>
                </tr>
            </table>
            
            <h3>7.1 Hitos y Entregables por Ruta</h3>
            
            <div class="diagram">
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    ROADMAP INTEGRADO RUTAS 1-2-3                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                                                 â”‚
â”‚  SEMANA   1    2    3    4    5    6    7    8    9   10   11   12                                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€               â”‚
â”‚                                                                                                                 â”‚
â”‚  RUTA 1   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                                                                                  â”‚
â”‚  Backend  â”‚â† BD â†’â”‚â† API â†’â”‚â† Test â†’â”‚                                                                             â”‚
â”‚           â”‚      â”‚       â”‚        â”‚                                                                             â”‚
â”‚           â”‚      â”‚       â”‚        â”‚                                                                             â”‚
â”‚  RUTA 2                  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                                                       â”‚
â”‚  Agentes                 â”‚â† Data â†’â”‚â† Model â†’â”‚â† Reg â†’â”‚â† Viz â†’â”‚â† Orq â†’â”‚                                          â”‚
â”‚                          â”‚ Agent  â”‚  Agent  â”‚ Agent â”‚ Agent â”‚uest.  â”‚                                          â”‚
â”‚                          â”‚        â”‚         â”‚       â”‚       â”‚       â”‚                                          â”‚
â”‚  RUTA 3                                                      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ                               â”‚
â”‚  Frontend                                                    â”‚â† UI â†’â”‚â† Deploy â†’â”‚â† Ajustes â†’â”‚                   â”‚
â”‚                                                                                                                 â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚  HITOS:                                                                                                         â”‚
â”‚                                                                                                                 â”‚
â”‚  ğŸ”µ Sem 3: BD + API base lista                                                                                  â”‚
â”‚  ğŸŸ£ Sem 5: CÃ¡lculo plusvalÃ­a funcional                                                                          â”‚
â”‚  ğŸŸ£ Sem 8: Sistema multi-agente integrado                                                                       â”‚
â”‚  ğŸŸ¢ Sem 11: Deploy producciÃ³n Pudahuel                                                                          â”‚
â”‚  âœ… Sem 12: Entrega formal al municipio                                                                         â”‚
â”‚                                                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            </div>
        </section>
        
        <!-- SECCIÃ“N 8: CÃ“DIGO -->
        <section class="section" id="codigo">
            <h2>ğŸ’» 8. CÃ“DIGO DE IMPLEMENTACIÃ“N INICIAL</h2>
            
            <div class="alert alert-info">
                <strong>ğŸ“Œ Nota:</strong> Este es el cÃ³digo base para iniciar la implementaciÃ³n. Se continuarÃ¡ desarrollando en etapas siguientes.
            </div>
            
            <h3>8.1 Estructura de Directorios Propuesta</h3>
            
            <div class="code-block">
DATAPOLIS_AI/
â”œâ”€â”€ api/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ main_api.py                 # FastAPI principal (existente)
â”‚   â””â”€â”€ routers/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ plusvalia_urbana.py     # Router M07-PU (NUEVO)
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ rlm/                        # RLM Engine (existente)
â”‚   â”œâ”€â”€ events/                     # Event Bus (existente)
â”‚   â””â”€â”€ memory/                     # Memory Manager (existente)
â”œâ”€â”€ modules/
â”‚   â”œâ”€â”€ all_modules.py              # MÃ³dulos existentes
â”‚   â””â”€â”€ plusvalia_urbana/           # NUEVO MÃ“DULO M07-PU
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ service.py              # Servicio principal
â”‚       â”œâ”€â”€ agents/
â”‚       â”‚   â”œâ”€â”€ __init__.py
â”‚       â”‚   â”œâ”€â”€ data_agent.py       # Agente de datos
â”‚       â”‚   â”œâ”€â”€ model_agent.py      # Agente de modelaciÃ³n
â”‚       â”‚   â”œâ”€â”€ regulatory_agent.py # Agente regulatorio
â”‚       â”‚   â””â”€â”€ visualization_agent.py # Agente visualizaciÃ³n
â”‚       â”œâ”€â”€ models/
â”‚       â”‚   â”œâ”€â”€ __init__.py
â”‚       â”‚   â””â”€â”€ entities.py         # Modelos SQLModel
â”‚       â”œâ”€â”€ schemas/
â”‚       â”‚   â”œâ”€â”€ __init__.py
â”‚       â”‚   â””â”€â”€ requests.py         # Schemas Pydantic
â”‚       â””â”€â”€ utils/
â”‚           â”œâ”€â”€ __init__.py
â”‚           â”œâ”€â”€ formulas.py         # FÃ³rmulas Ley 21.713
â”‚           â””â”€â”€ geo.py              # Utilidades PostGIS
â”œâ”€â”€ config/
â”‚   â””â”€â”€ settings.py                 # ConfiguraciÃ³n (existente)
â”œâ”€â”€ alembic/
â”‚   â””â”€â”€ versions/                   # Migraciones BD
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ test_integration.py         # Tests existentes
â”‚   â””â”€â”€ test_plusvalia_urbana.py    # Tests M07-PU (NUEVO)
â”œâ”€â”€ frontend/                       # Next.js (existente)
â”œâ”€â”€ docker-compose.yml              # Docker (existente)
â”œâ”€â”€ requirements.txt                # Dependencias (actualizar)
â””â”€â”€ README.md
            </div>
            
            <h3>8.2 Servicio Principal M07-PU</h3>
            
            <div class="file-header">
                <span>ğŸ“ modules/plusvalia_urbana/service.py</span>
                <span class="lang">Python 3.11+</span>
            </div>
            <div class="code-block">
"""
================================================================================
M07-PU: MÃ“DULO DE PLUSVALÃAS URBANAS
================================================================================
Servicio principal que orquesta los agentes especializados para anÃ¡lisis
de plusvalÃ­a y valorizaciÃ³n territorial.

Caso de uso: Municipio de Pudahuel (SECPLAC, DOM, AlcaldÃ­a, JurÃ­dica)

Stack: FastAPI + SQLModel + PostGIS + Ollama + Prophet

VersiÃ³n: 1.0.0
Autor: DATAPOLIS SpA
Fecha: 2026-02-04
================================================================================
"""

from typing import Dict, Any, Optional, List
from dataclasses import dataclass, field
from datetime import datetime, date
from decimal import Decimal
from enum import Enum
import asyncio
import logging

from sqlmodel import Session, select
from geoalchemy2.functions import ST_Within, ST_Buffer

# Imports internos
from modules.plusvalia_urbana.agents.data_agent import DataAgent
from modules.plusvalia_urbana.agents.model_agent import ModelAgent
from modules.plusvalia_urbana.agents.regulatory_agent import RegulatoryAgent
from modules.plusvalia_urbana.agents.visualization_agent import VisualizationAgent
from modules.plusvalia_urbana.models.entities import (
    Manzana, Predio, ValoracionManzana, CalculoPlusvalia, AlertaPlusvalia
)
from core.events.event_bus import EventBus, Event, EventType

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger("M07-PU.Service")


# =============================================================================
# ENUMS Y CONFIGURACIÃ“N
# =============================================================================

class UnidadMunicipal(Enum):
    """Unidades municipales destino de reportes"""
    SECPLAC = "secplac"
    DOM = "dom"
    ALCALDIA = "alcaldia"
    JURIDICA = "juridica"
    OTRAS = "otras"


class TipoAnalisis(Enum):
    """Tipos de anÃ¡lisis disponibles"""
    PLUSVALIA_HISTORICA = "plusvalia_historica"
    PROYECCION_VALOR = "proyeccion_valor"
    CONSOLIDACION = "consolidacion"
    COMPARATIVO = "comparativo"
    ALERTA = "alerta"


@dataclass
class ConfiguracionPlusvalia:
    """ConfiguraciÃ³n del mÃ³dulo"""
    comuna_codigo: str = "13119"  # Pudahuel
    horizonte_prediccion_meses: int = 12
    umbral_alerta_plusvalia: float = 15.0  # 15%
    umbral_alerta_caida: float = -10.0  # -10%
    modelo_prediccion: str = "prophet"  # "prophet", "arima", "xgboost"
    confianza_minima: float = 0.7


# =============================================================================
# SERVICIO PRINCIPAL
# =============================================================================

class M07_PlusvaliaUrbanaService:
    """
    Servicio principal del MÃ³dulo de PlusvalÃ­as Urbanas.
    
    Orquesta los 4 agentes especializados:
    - DataAgent: RecolecciÃ³n y validaciÃ³n de datos
    - ModelAgent: CÃ¡lculos y predicciones
    - RegulatoryAgent: AnÃ¡lisis normativo
    - VisualizationAgent: Mapas y reportes
    
    IntegraciÃ³n con DATAPOLIS AI:
    - Usa Event Bus para comunicaciÃ³n con otros mÃ³dulos
    - Usa RLM Engine para consultas NLP complejas
    - Usa Memory Manager para persistencia de contexto
    """
    
    def __init__(
        self,
        db_session: Session,
        event_bus: EventBus,
        config: Optional[ConfiguracionPlusvalia] = None
    ):
        self.db = db_session
        self.event_bus = event_bus
        self.config = config or ConfiguracionPlusvalia()
        
        # Inicializar agentes
        self.data_agent = DataAgent(db_session, event_bus)
        self.model_agent = ModelAgent(db_session, event_bus)
        self.regulatory_agent = RegulatoryAgent(db_session, event_bus)
        self.viz_agent = VisualizationAgent(db_session, event_bus)
        
        # Registrar handlers de eventos
        self._register_event_handlers()
        
        logger.info(f"M07-PU Service inicializado para comuna {self.config.comuna_codigo}")
    
    def _register_event_handlers(self):
        """Registra handlers para eventos de otros mÃ³dulos"""
        
        # Escuchar detecciones de M04 (construcciones)
        self.event_bus.subscribe(
            "construccion.detectada",
            self._handle_construccion_detectada
        )
        
        # Escuchar cambios normativos
        self.event_bus.subscribe(
            "normativa.actualizada",
            self._handle_normativa_actualizada
        )
    
    # =========================================================================
    # MÃ‰TODOS PRINCIPALES
    # =========================================================================
    
    async def calcular_plusvalia(
        self,
        zona_id: Optional[int] = None,
        predio_id: Optional[int] = None,
        fecha_inicio: Optional[date] = None,
        fecha_fin: Optional[date] = None
    ) -> Dict[str, Any]:
        """
        Calcula plusvalÃ­a histÃ³rica de una zona o predio.
        
        Flujo:
        1. DataAgent obtiene transacciones del perÃ­odo
        2. ModelAgent aplica fÃ³rmulas Ley 21.713
        3. RegulatoryAgent valida cumplimiento normativo
        4. VisualizationAgent genera reporte
        
        Args:
            zona_id: ID de manzana (opcional)
            predio_id: ID de predio (opcional)
            fecha_inicio: Inicio del perÃ­odo
            fecha_fin: Fin del perÃ­odo
            
        Returns:
            Dict con plusvalÃ­a calculada, detalle y mÃ©tricas
        """
        logger.info(f"Calculando plusvalÃ­a: zona={zona_id}, predio={predio_id}")
        
        # Valores por defecto
        fecha_fin = fecha_fin or date.today()
        fecha_inicio = fecha_inicio or date(fecha_fin.year - 5, 1, 1)
        
        # PASO 1: Obtener datos
        datos = await self.data_agent.obtener_transacciones(
            zona_id=zona_id,
            predio_id=predio_id,
            fecha_inicio=fecha_inicio,
            fecha_fin=fecha_fin
        )
        
        if not datos["transacciones"]:
            return {
                "success": False,
                "error": "No se encontraron transacciones en el perÃ­odo",
                "zona_id": zona_id,
                "predio_id": predio_id
            }
        
        # PASO 2: Calcular plusvalÃ­a
        resultado = await self.model_agent.calcular_plusvalia_ley_21713(
            transacciones=datos["transacciones"],
            fecha_inicio=fecha_inicio,
            fecha_fin=fecha_fin
        )
        
        # PASO 3: Validar normativa
        validacion = await self.regulatory_agent.validar_calculo(
            resultado=resultado,
            zona_id=zona_id
        )
        
        # PASO 4: Emitir evento
        await self.event_bus.publish(Event(
            type=EventType.DATA_PROCESSED,
            name="plusvalia.calculada",
            data={
                "zona_id": zona_id,
                "predio_id": predio_id,
                "plusvalia_pct": resultado["plusvalia_pct"],
                "fecha_calculo": datetime.utcnow().isoformat()
            }
        ))
        
        return {
            "success": True,
            "zona_id": zona_id,
            "predio_id": predio_id,
            "periodo": {
                "inicio": fecha_inicio.isoformat(),
                "fin": fecha_fin.isoformat()
            },
            "plusvalia": resultado,
            "validacion_normativa": validacion,
            "datos_base": {
                "num_transacciones": len(datos["transacciones"]),
                "fuentes": datos["fuentes"]
            }
        }
    
    async def proyectar_valor(
        self,
        zona_id: Optional[int] = None,
        predio_id: Optional[int] = None,
        horizonte_meses: int = 12
    ) -> Dict[str, Any]:
        """
        Genera proyecciÃ³n de valor futuro usando modelos ML.
        
        Modelos disponibles:
        - Prophet: Series temporales con estacionalidad
        - ARIMA: Autoregresivo integrado
        - XGBoost: Gradient boosting con features adicionales
        
        Args:
            zona_id: ID de manzana
            predio_id: ID de predio
            horizonte_meses: Meses a proyectar
            
        Returns:
            Dict con proyecciÃ³n, intervalos de confianza y mÃ©tricas
        """
        logger.info(f"Proyectando valor: zona={zona_id}, horizonte={horizonte_meses}m")
        
        # Obtener serie histÃ³rica
        serie = await self.data_agent.obtener_serie_temporal(
            zona_id=zona_id,
            predio_id=predio_id
        )
        
        # Generar predicciÃ³n
        prediccion = await self.model_agent.predecir_valor(
            serie=serie,
            horizonte_meses=horizonte_meses,
            modelo=self.config.modelo_prediccion
        )
        
        # Generar visualizaciÃ³n
        grafico = await self.viz_agent.generar_grafico_prediccion(
            serie=serie,
            prediccion=prediccion
        )
        
        # Emitir evento
        await self.event_bus.publish(Event(
            type=EventType.PREDICTION_GENERATED,
            name="prediccion.generada",
            data={
                "zona_id": zona_id,
                "horizonte": horizonte_meses,
                "valor_predicho": prediccion["valor_predicho"]
            }
        ))
        
        return {
            "success": True,
            "zona_id": zona_id,
            "predio_id": predio_id,
            "modelo": self.config.modelo_prediccion,
            "horizonte_meses": horizonte_meses,
            "prediccion": prediccion,
            "grafico_url": grafico["url"],
            "metricas_modelo": prediccion["metricas"]
        }
    
    async def generar_mapa_plusvalia(
        self,
        comuna_codigo: str = "13119",
        periodo: str = "2025-01",
        tipo_mapa: str = "heatmap"
    ) -> Dict[str, Any]:
        """
        Genera mapa temÃ¡tico de plusvalÃ­a para visualizaciÃ³n.
        
        Tipos de mapa:
        - heatmap: Calor por valor UF/mÂ²
        - coroplÃ©tico: Colores por manzana
        - puntos: Transacciones individuales
        - cambios: DetecciÃ³n de cambios satelitales
        
        Args:
            comuna_codigo: CÃ³digo INE de la comuna
            periodo: Mes de anÃ¡lisis (YYYY-MM)
            tipo_mapa: Tipo de visualizaciÃ³n
            
        Returns:
            Dict con URL del mapa y datos asociados
        """
        logger.info(f"Generando mapa {tipo_mapa} para {comuna_codigo}, perÃ­odo {periodo}")
        
        # Obtener datos geoespaciales
        datos_geo = await self.data_agent.obtener_datos_geoespaciales(
            comuna_codigo=comuna_codigo,
            periodo=periodo
        )
        
        # Generar mapa
        mapa = await self.viz_agent.generar_mapa(
            datos=datos_geo,
            tipo=tipo_mapa,
            titulo=f"PlusvalÃ­a {comuna_codigo} - {periodo}"
        )
        
        return {
            "success": True,
            "comuna": comuna_codigo,
            "periodo": periodo,
            "tipo_mapa": tipo_mapa,
            "mapa_url": mapa["url"],
            "mapa_html": mapa["html"],
            "estadisticas": datos_geo["estadisticas"],
            "leyenda": mapa["leyenda"]
        }
    
    async def generar_reporte(
        self,
        unidad: UnidadMunicipal,
        tipo_analisis: TipoAnalisis,
        parametros: Dict[str, Any]
    ) -> Dict[str, Any]:
        """
        Genera reporte personalizado para unidad municipal.
        
        Args:
            unidad: Unidad destino (SECPLAC, DOM, etc.)
            tipo_analisis: Tipo de anÃ¡lisis requerido
            parametros: ParÃ¡metros especÃ­ficos del anÃ¡lisis
            
        Returns:
            Dict con reporte generado en mÃºltiples formatos
        """
        logger.info(f"Generando reporte {tipo_analisis.value} para {unidad.value}")
        
        # Ejecutar anÃ¡lisis segÃºn tipo
        if tipo_analisis == TipoAnalisis.PLUSVALIA_HISTORICA:
            datos = await self.calcular_plusvalia(**parametros)
        elif tipo_analisis == TipoAnalisis.PROYECCION_VALOR:
            datos = await self.proyectar_valor(**parametros)
        elif tipo_analisis == TipoAnalisis.CONSOLIDACION:
            datos = await self._analizar_consolidacion(**parametros)
        elif tipo_analisis == TipoAnalisis.COMPARATIVO:
            datos = await self._analizar_comparativo(**parametros)
        else:
            datos = {"tipo": tipo_analisis.value, "parametros": parametros}
        
        # Generar reporte en formatos requeridos
        reporte = await self.viz_agent.generar_reporte(
            datos=datos,
            unidad=unidad,
            formato=["pdf", "excel", "html"]
        )
        
        # Emitir evento
        await self.event_bus.publish(Event(
            type=EventType.REPORT_GENERATED,
            name="reporte.generado",
            data={
                "unidad": unidad.value,
                "tipo": tipo_analisis.value,
                "reporte_id": reporte["id"]
            }
        ))
        
        return {
            "success": True,
            "unidad": unidad.value,
            "tipo_analisis": tipo_analisis.value,
            "reporte": reporte,
            "urls": {
                "pdf": reporte["url_pdf"],
                "excel": reporte["url_excel"],
                "html": reporte["url_html"]
            }
        }
    
    # =========================================================================
    # HANDLERS DE EVENTOS
    # =========================================================================
    
    async def _handle_construccion_detectada(self, event: Event):
        """Handler para evento de M04: construcciÃ³n detectada"""
        logger.info(f"Recibido evento construccion.detectada: {event.data}")
        
        # Recalcular plusvalÃ­a de la zona afectada
        zona_id = event.data.get("manzana_id")
        if zona_id:
            await self.calcular_plusvalia(zona_id=zona_id)
            
            # Generar alerta si hay impacto significativo
            await self._evaluar_y_generar_alerta(
                zona_id=zona_id,
                motivo="construccion_detectada",
                datos=event.data
            )
    
    async def _handle_normativa_actualizada(self, event: Event):
        """Handler para evento: normativa actualizada"""
        logger.info(f"Recibido evento normativa.actualizada: {event.data}")
        
        # Recargar base de conocimiento del RegulatoryAgent
        await self.regulatory_agent.actualizar_base_conocimiento(
            normativa=event.data.get("normativa")
        )
    
    # =========================================================================
    # MÃ‰TODOS AUXILIARES
    # =========================================================================
    
    async def _analizar_consolidacion(self, **kwargs) -> Dict[str, Any]:
        """AnÃ¡lisis de nivel de consolidaciÃ³n urbana"""
        # TODO: Implementar lÃ³gica de consolidaciÃ³n
        return {"tipo": "consolidacion", "pendiente": True}
    
    async def _analizar_comparativo(self, **kwargs) -> Dict[str, Any]:
        """AnÃ¡lisis comparativo entre zonas/comunas"""
        # TODO: Implementar anÃ¡lisis comparativo
        return {"tipo": "comparativo", "pendiente": True}
    
    async def _evaluar_y_generar_alerta(
        self,
        zona_id: int,
        motivo: str,
        datos: Dict
    ):
        """EvalÃºa si corresponde generar una alerta"""
        # LÃ³gica de evaluaciÃ³n de umbrales
        pass
</div>
            
            <div class="alert alert-success">
                <strong>âœ… CÃ³digo Base Entregado:</strong> Este servicio principal (M07_PlusvaliaUrbanaService) define la arquitectura y flujos principales. En las siguientes etapas se implementarÃ¡n los agentes especÃ­ficos (DataAgent, ModelAgent, RegulatoryAgent, VisualizationAgent) con toda su lÃ³gica de negocio.
            </div>
        </section>
        
        <!-- FOOTER -->
        <footer style="text-align: center; padding: 40px; color: #64748b; background: white; border-radius: 16px; margin-top: 25px;">
            <h3 style="color: var(--primary); margin-bottom: 15px;">DATAPOLIS AI + MÃ³dulo PlusvalÃ­as Urbanas</h3>
            <p>IntegraciÃ³n del Sistema Multi-Agente con MÃ³dulo M07-PU</p>
            <p style="margin-top: 15px;">Caso de Uso: Municipio de Pudahuel (SECPLAC, DOM, AlcaldÃ­a, JurÃ­dica)</p>
            <p style="margin-top: 20px; font-size: 0.9rem;">Â© 2026 DATAPOLIS SpA - Documento generado por Claude Opus 4.5</p>
            <p style="font-size: 0.85rem;">Fecha: 04 de Febrero 2026 | VersiÃ³n: 1.0.0</p>
        </footer>
    </div>
</body>
</html>
